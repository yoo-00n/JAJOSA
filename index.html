<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PNU í˜‘ì˜Â·ì„œëª… ê´€ë¦¬ Â· ì‘ì—…ë°©(ì‚¬ì—…ì§€êµ¬)ë³„ í´ë”</title>
  <style>
    :root{
      --bg:#0b1020; --card:#111834; --muted:#8fa3c1; --text:#e8eefb; --brand:#5aa0ff; --accent:#46e0b7; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0a0f1e 0%,#0b1226 100%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:rgba(10,15,30,.7);border-bottom:1px solid rgba(255,255,255,.06)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:8px 0 12px;font-size:20px;letter-spacing:.2px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .btn{border:1px solid rgba(255,255,255,.1);background:#141b36;color:var(--text);padding:10px 14px;border-radius:12px;font-size:14px;cursor:pointer}
    .btn:hover{border-color:rgba(255,255,255,.2)}
    .btn.brand{background:linear-gradient(180deg,#579bff,#4f8fff);border:none;color:white}
    .btn.accent{background:linear-gradient(180deg,#49e6bb,#35cfa6);border:none;color:#0b1020}
    .btn.danger{background:#331a1a;border:1px solid #582727;color:#ffb3b3}
    .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,.25)}
    .grid{display:grid;gap:14px}
    .card{background:linear-gradient(180deg,#0f1734 0%,#0d142c 100%);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f1734;color:var(--text);font-size:14px}
    input[type="file"]{padding:8px;background:transparent;border:1px dashed rgba(255,255,255,.25)}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-size:12px;color:var(--muted);text-align:left;padding:4px 8px}
    tbody td{background:#0f1734;padding:10px 8px;border-top:1px solid rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.06)}
    tbody tr{transition:transform .12s ease}
    tbody tr:hover{transform:translateY(-1px)}
    tbody td:first-child{border-left:1px solid rgba(255,255,255,.06);border-top-left-radius:12px;border-bottom-left-radius:12px}
    tbody td:last-child{border-right:1px solid rgba(255,255,255,.06);border-top-right-radius:12px;border-bottom-right-radius:12px}
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 10px;font-size:12px;border:1px solid rgba(255,255,255,.12)}
    .pill.ok{background:rgba(70,224,183,.12);color:#8af0d8;border-color:rgba(70,224,183,.3)}
    .pill.no{background:rgba(255,107,107,.1);color:#ffc1c1;border-color:rgba(255,107,107,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    .right{margin-left:auto}
    .muted{color:var(--muted)}
    .sr{position:absolute;left:-9999px}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:40}
    .modal.open{display:flex}
    .modal .sheet{background:#0f1734;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;max-width:95vw;width:680px}
    canvas{width:100%;height:320px;background:white;border-radius:12px}
    .help{font-size:13px;color:var(--muted)}
    .small{font-size:12px}
    .tag{display:inline-block;background:#16224a;border:1px solid rgba(255,255,255,.1);padding:2px 8px;border-radius:8px;color:#b9c8e3;font-size:12px}
    .kbar{display:flex;gap:8px;align-items:center;margin:8px 0}
    .kbar input{flex:1}
    footer{padding:40px 16px;color:#8fa3c1;text-align:center}
    @media (max-width:820px){
      .hide-m{display:none}
      header .toolbar{gap:6px}
      .btn{padding:8px 10px}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ğŸ“‘ PNU í˜‘ì˜Â·ì„œëª… ê´€ë¦¬ <span class="muted">Â· ì‘ì—…ë°©(ì‚¬ì—…ì§€êµ¬)ë³„</span></h1>
      <div class="toolbar">
        <!-- ì‘ì—…ë°© ì„ íƒ/ê´€ë¦¬ -->
        <label class="muted">ì‘ì—…ë°©</label>
        <select id="wsSelect" title="ì‘ì—…ë°©(ì‚¬ì—…ì§€êµ¬) ì„ íƒ"></select>
        <button id="btnAddWs" class="btn">+ ì‘ì—…ë°©</button>
        <button id="btnRenameWs" class="btn">ì´ë¦„ë³€ê²½</button>
        <button id="btnDelWs" class="btn danger">ì‚­ì œ</button>
        <span class="right"></span>

        <!-- íŒŒì¼ ì…ì¶œë ¥ -->
        <label class="btn ghost" for="excelFile">ğŸ“¥ ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°</label>
        <input id="excelFile" class="sr" type="file" accept=".xlsx,.xls" />
        <button id="btnTemplate" class="btn">ğŸ“„ í…œí”Œë¦¿</button>
        <button id="btnExportXlsx" class="btn">ğŸ“¤ ì—‘ì…€ë¡œ</button>
        <button id="btnExportJson" class="btn">ğŸ§° ë°±ì—…(JSON)</button>
        <button id="btnImportJson" class="btn">ğŸ§° ë³µì›(JSON)</button>
        <input id="jsonFile" class="sr" type="file" accept="application/json" />
        <button id="btnReset" class="btn danger">DB ì´ˆê¸°í™”</button>
      </div>
    </div>
  </header>

  <main class="wrap grid" style="margin-top:8px">
    <section class="card" id="howto">
      <div class="row">
        <div>
          <strong>ëª©ì </strong>
          <div class="help">ì‘ì—…ë°©(ì‚¬ì—…ì§€êµ¬/í–‰ì •êµ¬ì—­) ë‹¨ìœ„ë¡œ <span class="tag">PNU</span>ë³„ <span class="tag">ì†Œìœ ì</span>Â·<span class="tag">ì§€ë²ˆ</span>Â·<span class="tag">í˜‘ì˜ë‚´ìš©</span>Â·<span class="tag">ì „ìì„œëª…</span>ì„ ê´€ë¦¬í•©ë‹ˆë‹¤. ê° ì‘ì—…ë°©ì€ í´ë”ì²˜ëŸ¼ ì™„ì „íˆ ë¶„ë¦¬ë©ë‹ˆë‹¤.</div>
        </div>
        <div class="right help hide-m">ì €ì¥ ìœ„ì¹˜: ë¸Œë¼ìš°ì € ë¡œì»¬ DB(IndexedDB). ì—¬ëŸ¬ ëª… ê³µë™ ì‘ì—…ì€ ë°±ì—”ë“œ ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>
      </div>
    </section>

    <section class="card" id="importer">
      <div class="row">
        <div>
          <label for="excelFile"><strong>1) ì—‘ì…€(.xlsx) ì„ íƒ</strong></label>
          <div class="help">í•„ìˆ˜ í—¤ë” ê¶Œì¥: <code>PNU</code>, <code>ì†Œìœ ì</code>, <code>ì§€ë²ˆ</code>, <code>í˜‘ì˜ë‚´ìš©</code> (í—¤ë”ëª…ì´ ë‹¬ë¼ë„ ë§¤í•‘ ê°€ëŠ¥). ì—…ë¡œë“œëŠ” <strong>í˜„ì¬ ì‘ì—…ë°©</strong>ì— ë°˜ì˜ë©ë‹ˆë‹¤.</div>
        </div>
      </div>
      <div id="mapBox" style="display:none;margin-top:12px">
        <div class="row">
          <div><label>ì—‘ì…€ í—¤ë” â†’ PNU</label><select id="mapPnu"></select></div>
          <div><label>ì—‘ì…€ í—¤ë” â†’ ì†Œìœ ì</label><select id="mapOwner"></select></div>
          <div><label>ì—‘ì…€ í—¤ë” â†’ ì§€ë²ˆ</label><select id="mapLot"></select></div>
          <div><label>ì—‘ì…€ í—¤ë” â†’ í˜‘ì˜ë‚´ìš©</label><select id="mapNote"></select></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnApplyMap" class="btn brand">ë§¤í•‘ ì ìš© & ì €ì¥</button>
          <div class="help">ë™ì¼ PNUëŠ” ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤(ì‘ì—…ë°© ë‚´ì—ì„œë§Œ).</div>
        </div>
      </div>
    </section>

    <section class="card" id="editor">
      <div class="kbar">
        <input id="q" placeholder="PNU ë˜ëŠ” ì†Œìœ ì/ì§€ë²ˆ ê²€ìƒ‰ (í˜„ì¬ ì‘ì—…ë°©)" />
        <button id="btnNew" class="btn accent">+ ì‹ ê·œ</button>
      </div>
      <div class="help">PNUëŠ” ê³ ìœ í‚¤ì…ë‹ˆë‹¤(ë¬¸ìì—´ ì €ì¥). ì‘ì—…ë°©ë§ˆë‹¤ ë³„ë„ë¡œ ê´€ë¦¬ë©ë‹ˆë‹¤.</div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th style="min-width:160px">PNU</th>
              <th style="min-width:140px">ì†Œìœ ì</th>
              <th style="min-width:160px">ì§€ë²ˆ</th>
              <th>í˜‘ì˜ ë‚´ìš©</th>
              <th class="hide-m" style="min-width:120px">ì„œëª…</th>
              <th style="min-width:220px">ì‘ì—…</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>

    <section class="card" id="cloudInfo">
      <strong>ì—¬ëŸ¬ ëª…ì´ í•¨ê»˜ ì“°ê¸°(ì„ íƒ)</strong>
      <div class="help">í˜„ì¬ëŠ” ë¡œì»¬ ì „ìš©ì…ë‹ˆë‹¤. ê³µë™ ì‚¬ìš©ì„ ì›í•˜ë©´ Firebase/Supabase ì—°ë™ ë²„ì „ì„ ìš”ì²­í•˜ì„¸ìš”(ì‘ì—…ë°©ë³„ ê¶Œí•œ/ë¡œê·¸ í¬í•¨).</div>
    </section>
  </main>

  <footer>
    <div class="small">â€» ì„œëª…ì€ ì´ë¯¸ì§€ ìº¡ì²˜ì…ë‹ˆë‹¤. ë²•ì  ì „ìì„œëª…ì€ ë³„ë„ ì—°ë™ í•„ìš”.</div>
  </footer>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>

  <script>
  // ------------------------------
  // DB (IndexedDB via Dexie) â€” ì‘ì—…ë°©(Workspace) ì§€ì›
  // ------------------------------
  const db = new Dexie('pnu_agreements');
  // v1 â†’ v2 ë§ˆì´ê·¸ë ˆì´ì…˜: records(pnu), signatures(pnu) â†’ ì‘ì—…ë°© ë¶„ë¦¬ êµ¬ì¡°
  db.version(1).stores({
    records: 'pnu',
    signatures: 'pnu'
  });
  db.version(2).stores({
    workspaces: 'name',                   // ì‘ì—…ë°© ì´ë¦„ ê³ ìœ 
    records: '[ws+pnu], ws, pnu',         // ë³µí•© PK: ì‘ì—…ë°©+PNU
    signatures: '[ws+pnu], ws, pnu'       // ì„œëª…ë„ ì‘ì—…ë°©ë³„ ë¶„ë¦¬
  }).upgrade(async tx => {
    // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆë‹¤ë©´ ê¸°ë³¸ ì‘ì—…ë°©("ê¸°ë³¸")ìœ¼ë¡œ ì´ë™
    const oldRecs = await tx.table('records').toArray().catch(()=>[]);
    const oldSigs = await tx.table('signatures').toArray().catch(()=>[]);
    if (oldRecs.length || oldSigs.length) {
      await tx.table('workspaces').put({ name: 'ê¸°ë³¸' });
      for (const r of oldRecs) {
        await tx.table('records').put({ ws:'ê¸°ë³¸', pnu:r.pnu, owner:r.owner, lot:r.lot, note:r.note });
      }
      for (const s of oldSigs) {
        await tx.table('signatures').put({ ws:'ê¸°ë³¸', pnu:s.pnu, dataUrl:s.dataUrl, signedAt:s.signedAt });
      }
    } else {
      // ìµœì´ˆ ì„¤ì¹˜ ì‹œ ê¸°ë³¸ ì‘ì—…ë°© ìƒì„±
      await tx.table('workspaces').put({ name: 'ê¸°ë³¸' });
    }
  });

  // DOM helpers
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const wsSelect = $('#wsSelect');

  // State
  let excelHeaders = [];
  let excelRows = [];
  let currentQuery = '';
  let currentWS = localStorage.getItem('pnu_current_ws') || 'ê¸°ë³¸';

  // Initialize workspaces select
  async function refreshWorkspaces(){
    let list = await db.workspaces.toArray();
    if(!list.find(w=>w.name===currentWS)){
      // ensure current exists
      if(list.length===0){ await db.workspaces.put({name:'ê¸°ë³¸'}); list = await db.workspaces.toArray(); }
      currentWS = list[0]?.name || 'ê¸°ë³¸';
      localStorage.setItem('pnu_current_ws', currentWS);
    }
    wsSelect.innerHTML = list.map(w=>`<option ${w.name===currentWS?'selected':''} value="${escapeHtml(w.name)}">${escapeHtml(w.name)}</option>`).join('');
  }

  wsSelect.addEventListener('change', async (e)=>{
    currentWS = e.target.value; localStorage.setItem('pnu_current_ws', currentWS); refreshList();
  });

  // Workspace CRUD buttons
  $('#btnAddWs').addEventListener('click', async ()=>{
    const name = prompt('ìƒˆ ì‘ì—…ë°© ì´ë¦„ (ì˜ˆ: ì„œìš¸-ì¢…ë¡œêµ¬, Aì§€êµ¬ 1ê³µêµ¬ ë“±)');
    if(!name) return; const n = name.trim(); if(!n) return;
    const exists = await db.workspaces.get(n);
    if(exists){ alert('ê°™ì€ ì´ë¦„ì˜ ì‘ì—…ë°©ì´ ì´ë¯¸ ìˆìŠµë‹ˆë‹¤.'); return; }
    await db.workspaces.put({ name:n });
    currentWS = n; localStorage.setItem('pnu_current_ws', currentWS);
    await refreshWorkspaces(); await refreshList();
  });

  $('#btnRenameWs').addEventListener('click', async ()=>{
    const old = currentWS;
    const neo = prompt(`ì‘ì—…ë°© ì´ë¦„ ë³€ê²½: ${old} â†’`, old);
    if(neo===null) return; const n = neo.trim(); if(!n) return;
    if(n===old) return;
    if(await db.workspaces.get(n)){ alert('í•´ë‹¹ ì´ë¦„ì€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.'); return; }
    // ì´ë¦„ ë³€ê²½: workspace ì´ë¦„ì„ ë³€ê²½í•˜ë©´ ê´€ë ¨ ë ˆì½”ë“œ í‚¤(ws)ë„ ì—…ë°ì´íŠ¸ í•„ìš”
    await db.transaction('rw', db.workspaces, db.records, db.signatures, async ()=>{
      await db.workspaces.delete(old);
      await db.workspaces.put({ name:n });
      const recs = await db.records.where('ws').equals(old).toArray();
      for(const r of recs){ await db.records.delete([old, r.pnu]); await db.records.put({ ...r, ws:n }); }
      const sigs = await db.signatures.where('ws').equals(old).toArray();
      for(const s of sigs){ await db.signatures.delete([old, s.pnu]); await db.signatures.put({ ...s, ws:n }); }
    });
    currentWS = n; localStorage.setItem('pnu_current_ws', currentWS);
    await refreshWorkspaces(); await refreshList();
  });

  $('#btnDelWs').addEventListener('click', async ()=>{
    const name = currentWS;
    const list = await db.workspaces.toArray();
    if(list.length<=1){ alert('ìµœì†Œ 1ê°œì˜ ì‘ì—…ë°©ì€ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
    if(!confirm(`ì‘ì—…ë°© "${name}"ì„(ë¥¼) ì‚­ì œí• ê¹Œìš”?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ê³ , í•´ë‹¹ ì‘ì—…ë°©ì˜ ëª¨ë“  ë ˆì½”ë“œ/ì„œëª…ì´ ì‚­ì œë©ë‹ˆë‹¤.`)) return;
    await db.transaction('rw', db.workspaces, db.records, db.signatures, async ()=>{
      await db.workspaces.delete(name);
      const recs = await db.records.where('ws').equals(name).toArray();
      for(const r of recs){ await db.records.delete([name, r.pnu]); }
      const sigs = await db.signatures.where('ws').equals(name).toArray();
      for(const s of sigs){ await db.signatures.delete([name, s.pnu]); }
    });
    // switch to another ws
    const remain = await db.workspaces.toArray();
    currentWS = remain[0].name; localStorage.setItem('pnu_current_ws', currentWS);
    await refreshWorkspaces(); await refreshList();
  });

  // Elements
  const fileInput = $('#excelFile');
  const mapBox = $('#mapBox');
  const mapPnu = $('#mapPnu');
  const mapOwner = $('#mapOwner');
  const mapLot = $('#mapLot');
  const mapNote = $('#mapNote');
  const btnApplyMap = $('#btnApplyMap');
  const rowsEl = $('#rows');
  const qEl = $('#q');

  // File upload handler
  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if(!file) return;
    const { headers, rows } = await parseExcel(file);
    excelHeaders = headers; excelRows = rows;
    buildMappingSelects(headers);
    mapBox.style.display = 'block';
  });

  function buildMappingSelects(headers){
    const fill = (sel, guessList=[]) => {
      sel.innerHTML = '<option value="">(ì‚¬ìš© ì•ˆí•¨)</option>' + headers.map((h,i)=>`<option value="${i}">${escapeHtml(h)}</option>`).join('');
      for(const g of guessList){
        const idx = headers.findIndex(h => h.toLowerCase().includes(g));
        if(idx>=0){ sel.value = String(idx); break; }
      }
    }
    fill(mapPnu, ['pnu','í•„ì§€','ê³ ìœ ','parcel']);
    fill(mapOwner, ['ì†Œìœ ','owner','ì„±ëª…','ì´ë¦„','ëŒ€í‘œ']);
    fill(mapLot, ['ì§€ë²ˆ','ì£¼ì†Œ','lot','parcel','address']);
    fill(mapNote, ['í˜‘ì˜','ë‚´ìš©','ë¹„ê³ ','note','memo']);
  }

  btnApplyMap.addEventListener('click', async () => {
    if(!excelRows.length){ alert('ì—‘ì…€ì„ ë¨¼ì € ë¶ˆëŸ¬ì˜¤ì„¸ìš”.'); return; }
    const idx = {
      pnu: parseInt(mapPnu.value,10),
      owner: parseInt(mapOwner.value,10),
      lot: parseInt(mapLot.value,10),
      note: parseInt(mapNote.value,10)
    };
    if(Number.isNaN(idx.pnu)) { alert('PNU ë§¤í•‘ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }

    let upserted = 0;
    await db.transaction('rw', db.records, async () => {
      for(const row of excelRows){
        const rec = {
          ws: currentWS,
          pnu: normalizePnu(cell(row, idx.pnu)),
          owner: cell(row, idx.owner),
          lot: cell(row, idx.lot),
          note: cell(row, idx.note)
        };
        if(!rec.pnu) continue;
        await db.records.put(rec); // key = [ws, pnu]
        upserted++;
      }
    });
    alert(`(${currentWS}) ì´ ${upserted.toLocaleString()}ê±´ ì €ì¥/ê°±ì‹  ì™„ë£Œ.`);
    mapBox.style.display = 'none';
    fileInput.value = '';
    await refreshList();
  });

  // Parse Excel (first sheet)
  async function parseExcel(file){
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, { type:'array' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { header:1, defval:'' });
    const headers = rows.shift()?.map(String) ?? [];
    return { headers, rows };
  }
  function cell(row, idx){ if(Number.isNaN(idx)) return ''; return (row?.[idx] ?? '').toString().trim(); }
  function normalizePnu(v){ if(!v) return ''; return String(v).replace(/\s+/g,'').replace(/[^0-9-]/g,''); }

  // Render list (current workspace only)
  async function refreshList(){
    const all = await db.records.where('ws').equals(currentWS).toArray();
    const sigs = await db.signatures.where('ws').equals(currentWS).toArray();
    const sigMap = new Map(sigs.map(s => [s.pnu, s]));

    const q = currentQuery.trim().toLowerCase();
    const filtered = q
      ? all.filter(r => r.pnu.toLowerCase().includes(q) || (r.owner||'').toLowerCase().includes(q) || (r.lot||'').toLowerCase().includes(q))
      : all;

    filtered.sort((a,b)=> a.pnu.localeCompare(b.pnu));

    rowsEl.innerHTML = filtered.map(r => {
      const s = sigMap.get(r.pnu);
      const signed = !!s?.dataUrl;
      const when = s?.signedAt ? new Date(s.signedAt).toLocaleString() : '';
      return `<tr>
        <td><span class="small muted">#</span> ${escapeHtml(r.pnu)}</td>
        <td>${escapeHtml(r.owner||'')}</td>
        <td>${escapeHtml(r.lot||'')}</td>
        <td>${escapeHtml(r.note||'')}</td>
        <td class="hide-m">${signed?`<span class="pill ok">ì„œëª… ì™„ë£Œ</span><div class="small muted">${escapeHtml(when)}</div>`:`<span class="pill no">ë¯¸ì„œëª…</span>`}</td>
        <td>
          <div class="row" style="gap:6px">
            <button class="btn" onclick="openEdit('${encodeURIComponent(r.pnu)}')">âœï¸ ìˆ˜ì •</button>
            <button class="btn accent" onclick="openSign('${encodeURIComponent(r.pnu)}')">âœï¸ ì„œëª…</button>
            <button class="btn" onclick="previewSign('${encodeURIComponent(r.pnu)}')">ğŸ–¼ï¸ ì„œëª…ë³´ê¸°</button>
            <button class="btn danger" onclick="delRec('${encodeURIComponent(r.pnu)}')">ğŸ—‘ï¸ ì‚­ì œ</button>
          </div>
        </td>
      </tr>`;
    }).join('');
  }

  qEl.addEventListener('input', (e)=>{ currentQuery = e.target.value; refreshList(); });

  // New record
  $('#btnNew').addEventListener('click', ()=> openEdit(''));

  async function delRec(encPnu){
    const pnu = decodeURIComponent(encPnu);
    if(!confirm(`ì‚­ì œí• ê¹Œìš”?\n[${currentWS}] PNU: ${pnu}`)) return;
    await db.transaction('rw', db.records, db.signatures, async () => {
      await db.records.delete([currentWS, pnu]);
      await db.signatures.delete([currentWS, pnu]);
    });
    refreshList();
  }

  // Simple edit modal using prompt (ë¹ ë¥¸ í¸ì§‘)
  async function openEdit(encPnu){
    const pnuKey = decodeURIComponent(encPnu);
    const rec = pnuKey ? (await db.records.get([currentWS, pnuKey])) : { pnu:'', owner:'', lot:'', note:'' };
    const pPnu = prompt(`[${currentWS}] PNU (ê³ ìœ í‚¤):`, rec?.pnu ?? '');
    if(pPnu===null) return;
    const pOwner = prompt('ì†Œìœ ì:', rec?.owner ?? ''); if(pOwner===null) return;
    const pLot = prompt('ì§€ë²ˆ:', rec?.lot ?? ''); if(pLot===null) return;
    const pNote = prompt('í˜‘ì˜ ë‚´ìš©:', rec?.note ?? ''); if(pNote===null) return;

    const newRec = { ws:currentWS, pnu: normalizePnu(pPnu), owner:pOwner.trim(), lot:pLot.trim(), note:pNote.trim() };
    if(!newRec.pnu){ alert('PNUëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }

    if(pnuKey && pnuKey!==newRec.pnu){ // í‚¤ ë³€ê²½ ì‹œ ê¸°ì¡´ ì‚­ì œ
      await db.records.delete([currentWS, pnuKey]);
      const sig = await db.signatures.get([currentWS, pnuKey]);
      if(sig){ await db.signatures.delete([currentWS, pnuKey]); await db.signatures.put({ ws:currentWS, pnu:newRec.pnu, ...sig }); }
    }
    await db.records.put(newRec);
    refreshList();
  }

  // Signature Modal (workspace-aware)
  let sigModal, sigPad, sigCanvas, sigCtx, sigPnu = '';
  function ensureSignModal(){
    if(sigModal) return;
    sigModal = document.createElement('div');
    sigModal.className = 'modal';
    sigModal.innerHTML = `
      <div class="sheet">
        <div class="row" style="align-items:center">
          <h3 style="margin:0">ì „ì ì„œëª…</h3>
          <span class="right"></span>
          <button class="btn" id="btnCloseSign">ë‹«ê¸°</button>
        </div>
        <div class="help" id="signTarget" style="margin:6px 0 10px"></div>
        <canvas id="sigCanvas" width="1024" height="512"></canvas>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnClearSig">ì§€ìš°ê¸°</button>
          <button class="btn brand" id="btnSaveSig">ì„œëª… ì €ì¥</button>
        </div>
        <div class="help">ì†ê°€ë½/íœìœ¼ë¡œ ì„œëª…í•´ ì£¼ì„¸ìš”. ì €ì¥ ì‹œ ì´ë¯¸ì§€ê°€ ë¡œì»¬ DBì— ì•”í˜¸í™” ì—†ì´ ì €ì¥ë©ë‹ˆë‹¤.</div>
      </div>`;
    document.body.appendChild(sigModal);

    sigCanvas = sigModal.querySelector('#sigCanvas');
    sigCtx = sigCanvas.getContext('2d');
    sigPad = new SignaturePad.SignaturePad(sigCanvas, { backgroundColor: 'white', penColor: 'black' });

    sigModal.querySelector('#btnCloseSign').addEventListener('click', ()=> closeSign());
    sigModal.querySelector('#btnClearSig').addEventListener('click', ()=> sigPad.clear());
    sigModal.querySelector('#btnSaveSig').addEventListener('click', saveSignature);

    const resizeCanvas = () => {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      const rect = sigCanvas.getBoundingClientRect();
      sigCanvas.width = rect.width * ratio; sigCanvas.height = rect.height * ratio; sigCtx.scale(ratio, ratio); sigPad.clear();
    };
    const ro = new ResizeObserver(resizeCanvas); ro.observe(sigCanvas);
  }

  window.openSign = async (encPnu) => {
    ensureSignModal();
    sigPnu = decodeURIComponent(encPnu);
    const rec = await db.records.get([currentWS, sigPnu]);
    if(!rec){ alert('ë ˆì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
    sigModal.querySelector('#signTarget').textContent = `[${currentWS}] PNU ${rec.pnu} Â· ${rec.owner||''} Â· ${rec.lot||''}`;
    sigPad.clear();
    const existing = await db.signatures.get([currentWS, sigPnu]);
    if(existing?.dataUrl){
      const img = new Image(); img.onload = ()=>{ const c = sigCanvas; const ctx = c.getContext('2d'); ctx.globalAlpha = 0.18; ctx.drawImage(img, 0, 0, c.width, c.height); ctx.globalAlpha = 1; };
      img.src = existing.dataUrl;
    }
    sigModal.classList.add('open');
  }
  function closeSign(){ sigModal?.classList.remove('open'); }
  async function saveSignature(){
    if(sigPad.isEmpty()){ alert('ì„œëª…ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.'); return; }
    const dataUrl = sigPad.toDataURL('image/png');
    await db.signatures.put({ ws:currentWS, pnu: sigPnu, dataUrl, signedAt: new Date().toISOString() });
    closeSign(); refreshList();
  }
  window.previewSign = async (encPnu) => {
    const pnu = decodeURIComponent(encPnu);
    const s = await db.signatures.get([currentWS, pnu]);
    if(!s?.dataUrl){ alert('ì„œëª…ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
    const win = window.open(); win.document.write(`<img alt="signature" src="${s.dataUrl}">`);
  }

  // Export: XLSX (í˜„ì¬ ì‘ì—…ë°©ë§Œ)
  $('#btnExportXlsx').addEventListener('click', async ()=>{
    const recs = await db.records.where('ws').equals(currentWS).toArray();
    const sigs = new Map((await db.signatures.where('ws').equals(currentWS).toArray()).map(s => [s.pnu, s]));
    const rows = recs.map(r=>({
      ì‘ì—…ë°©: currentWS,
      PNU: r.pnu,
      ì†Œìœ ì: r.owner||'',
      ì§€ë²ˆ: r.lot||'',
      í˜‘ì˜ë‚´ìš©: r.note||'',
      ì„œëª…ì—¬ë¶€: sigs.has(r.pnu) ? 'Y' : 'N',
      ì„œëª…ì‹œê°: sigs.get(r.pnu)?.signedAt ? new Date(sigs.get(r.pnu).signedAt).toLocaleString() : ''
    }));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, currentWS.slice(0,31));
    XLSX.writeFile(wb, `pnu_${sanitizeFile(currentWS)}_${fmtDate()}.xlsx`);
  });

  // Export/Import JSON (ì „ì²´ DB)
  $('#btnExportJson').addEventListener('click', async ()=>{
    const payload = {
      exportedAt: new Date().toISOString(),
      workspaces: await db.workspaces.toArray(),
      records: await db.records.toArray(),
      signatures: await db.signatures.toArray()
    };
    downloadBlob(new Blob([JSON.stringify(payload,null,2)], {type:'application/json'}), `pnu_backup_all_${fmtDate()}.json`);
  });
  $('#btnImportJson').addEventListener('click', ()=> $('#jsonFile').click());
  $('#jsonFile').addEventListener('change', async (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    const text = await f.text();
    const data = JSON.parse(text);
    if(!Array.isArray(data.records) || !Array.isArray(data.signatures)) { alert('ë°±ì—… í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
    await db.transaction('rw', db.workspaces, db.records, db.signatures, async ()=>{
      await db.workspaces.clear(); await db.records.clear(); await db.signatures.clear();
      const wsList = data.workspaces?.length ? data.workspaces : [{name:'ê¸°ë³¸'}];
      for(const w of wsList) await db.workspaces.put({ name:w.name });
      for(const r of data.records) await db.records.put(r);
      for(const s of data.signatures) await db.signatures.put(s);
    });
    await refreshWorkspaces(); alert('ë³µì› ì™„ë£Œ'); refreshList();
  });

  // Template xlsx (ì‘ì—…ë°© ë¬´ê´€)
  $('#btnTemplate').addEventListener('click', ()=>{
    const wb = XLSX.utils.book_new();
    const rows = [ { PNU:'1111010100100000000', ì†Œìœ ì:'í™ê¸¸ë™', ì§€ë²ˆ:'ì„œìš¸ ì¢…ë¡œêµ¬ 1-1', í˜‘ì˜ë‚´ìš©:'ë³´ìƒ í˜‘ì˜ 1ì°¨ ì™„ë£Œ' } ];
    const ws = XLSX.utils.json_to_sheet(rows); XLSX.utils.book_append_sheet(wb, ws, 'í…œí”Œë¦¿');
    XLSX.writeFile(wb, 'pnu_template.xlsx');
  });

  // Reset DB (ëª¨ë“  ì‘ì—…ë°© í¬í•¨ ì „ë¶€ ì‚­ì œ)
  $('#btnReset').addEventListener('click', async ()=>{
    if(!confirm('DBë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”? ëª¨ë“  ì‘ì—…ë°©ì˜ ë ˆì½”ë“œ/ì„œëª…ì´ ì‚­ì œë©ë‹ˆë‹¤.')) return;
    await db.transaction('rw', db.workspaces, db.records, db.signatures, async ()=>{ await db.workspaces.clear(); await db.records.clear(); await db.signatures.clear(); });
    await db.workspaces.put({ name:'ê¸°ë³¸' }); currentWS='ê¸°ë³¸'; localStorage.setItem('pnu_current_ws', currentWS);
    await refreshWorkspaces(); refreshList();
  });

  // Helpers
  function fmtDate(){ const d = new Date(); const p = n=> String(n).padStart(2,'0'); return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}`; }
  function downloadBlob(blob, filename){ const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click(); setTimeout(()=> URL.revokeObjectURL(a.href), 2000); }
  function escapeHtml(s){ return String(s??'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
  function sanitizeFile(s){ return s.replace(/[^\w\-ê°€-í£]/g,'_').slice(0,60); }

  // Kick
  (async function init(){ await refreshWorkspaces(); await refreshList(); })();
  </script>
</body>
</html>
