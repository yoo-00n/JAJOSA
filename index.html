<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ì¬ì¡°ì‚¬_ê²½ê³„í˜‘ì˜ì„œ_version1.1 (í•©ì˜ ê²½ê³„ í¬í•¨)</title>
  <style>
    :root{ --bg:#0b1020; --card:#111834; --muted:#8fa3c1; --text:#e8eefb; --brand:#5aa0ff; --accent:#46e0b7; --danger:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0a0f1e 0%,#0b1226 100%);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:rgba(10,15,30,.7);border-bottom:1px solid rgba(255,255,255,.06)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:8px 0 12px;font-size:20px;letter-spacing:.2px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .btn{border:1px solid rgba(255,255,255,.1);background:#141b36;color:var(--text);padding:10px 14px;border-radius:12px;font-size:14px;cursor:pointer}
    .btn:hover{border-color:rgba(255,255,255,.2)}
    .btn.brand{background:linear-gradient(180deg,#579bff,#4f8fff);border:none;color:white}
    .btn.accent{background:linear-gradient(180deg,#49e6bb,#35cfa6);border:none;color:#0b1020}
    .btn.danger{background:#331a1a;border:1px solid #582727;color:#ffb3b3}
    .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,.25)}
    .grid{display:grid;gap:14px}
    .card{background:linear-gradient(180deg,#0f1734 0%,#0d142c 100%);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f1734;color:var(--text);font-size:14px}
    input[type="file"]{padding:8px;background:transparent;border:1px dashed rgba(255,255,255,.25)}
    table{width:100%;border-collapse:separate;border-spacing:0 8px; table-layout:fixed}
    col.num{width:60px} col.pnu{width:120px} col.owner{width:120px} col.lot{width:140px} col.note{width:auto} col.sign{width:120px} col.ops{width:420px}
    thead th{font-size:12px;color:var(--muted);text-align:left;padding:4px 8px}
    tbody td{background:#0f1734;padding:10px 8px;border-top:1px solid rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.06);
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    tbody tr{transition:transform .12s ease}
    tbody tr:hover{transform:translateY(-1px)}
    tbody td:first-child{border-left:1px solid rgba(255,255,255,.06);border-top-left-radius:12px;border-bottom-left-radius:12px}
    tbody td:last-child{border-right:1px solid rgba(255,255,255,.06);border-top-right-radius:12px;border-bottom-right-radius:12px}
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 10px;font-size:12px;border:1px solid rgba(255,255,255,.12)}
    .pill.ok{background:rgba(70,224,183,.12);color:#8af0d8;border-color:rgba(70,224,183,.3)}
    .pill.no{background:rgba(255,107,107,.1);color:#ffc1c1;border-color:rgba(255,255,255,.25)}
    .pill.req{background:rgba(255,184,77,.12);color:#ffd699;border-color:rgba(255,184,77,.35)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    .right{margin-left:auto}
    .muted{color:var(--muted)}
    .sr{position:absolute;left:-9999px}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:40;padding:10px}
    .modal.open{display:flex}
    .modal .sheet{background:#0f1734;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;max-width:95vw;width:820px}
    .help{font-size:13px;color:var(--muted)} .small{font-size:12px}
    .tabs{display:flex;gap:6px;margin:8px 0} .tabs .btn{padding:6px 10px}
    canvas{width:100%;height:220px;background:white;border-radius:12px;touch-action:none}
    footer{padding:40px 16px;color:#8fa3c1;text-align:center}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .line{height:1px;background:rgba(255,255,255,.08);margin:10px 0}
    @media (max-width:820px){ .hide-m{display:none} header .toolbar{gap:6px} .btn{padding:8px 10px}
      col.pnu{width:110px} col.owner{width:110px} col.lot{width:130px} }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <h1>ğŸ“‘ ì¬ì¡°ì‚¬_ê²½ê³„í˜‘ì˜ì„œ <span class="muted">Â· version1.1 (í•©ì˜ ê²½ê³„)</span></h1>
      <div class="toolbar">
        <label class="muted">ì‘ì—…ë°©</label>
        <select id="wsSelect" title="ì‘ì—…ë°©(ì‚¬ì—…ì§€êµ¬) ì„ íƒ"></select>
        <button id="btnAddWs" class="btn">+ ì‘ì—…ë°©</button>
        <button id="btnRenameWs" class="btn">ì´ë¦„ë³€ê²½</button>
        <button id="btnDelWs" class="btn danger">ì‚­ì œ</button>
        <button id="btnLockWs" class="btn danger">ì‘ì—…ë°© ì ê¸ˆ</button>

        <span class="right"></span>

        <input id="q" placeholder="PNU / ì†Œìœ ì / ì§€ë²ˆ ê²€ìƒ‰" style="max-width:280px">
        <button id="sortOwnerAsc" class="btn">ì†Œìœ ì â–²</button>
        <button id="sortOwnerDesc" class="btn">ì†Œìœ ì â–¼</button>

        <label class="btn ghost" for="excelFile">ğŸ“¥ ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°</label>
        <input id="excelFile" class="sr" type="file" accept=".xlsx,.xls" />
        <button id="btnTemplate" class="btn">ğŸ“„ í…œí”Œë¦¿</button>
        <button id="btnExportXlsx" class="btn">ğŸ“¤ ì—‘ì…€ë¡œ(ì´ë¯¸ì§€ í¬í•¨)</button>
        <button id="btnExportJson" class="btn">ğŸ§° ë°±ì—…(JSON)</button>
        <button id="btnImportJson" class="btn">ğŸ§° ë³µì›(JSON)</button>
        <input id="jsonFile" class="sr" type="file" accept="application/json" />
        <button id="btnReset" class="btn danger">DB ì´ˆê¸°í™”</button>
      </div>
    </div>
  </header>

  <main class="wrap grid" style="margin-top:8px">
    <section class="card" id="howto">
      <div class="row">
        <div>
          <strong>ëª©ì </strong>
          <div class="help">ì‘ì—…ë°© ë‹¨ìœ„ë¡œ PNUë³„ ì†Œìœ ìÂ·ì§€ë²ˆÂ·í˜‘ì˜ë‚´ìš©Â·ì „ìì„œëª…(PNG ì—…ë¡œë“œ/ì§ì ‘)ì„ ê´€ë¦¬í•˜ê³ , <b>í•©ì˜ ê²½ê³„</b>(Aâ†”B ìƒí˜¸ í•©ì˜) ìš”ì²­Â·ì„œëª…Â·PDF ì €ì¥Â·í‘œì‹œê¹Œì§€ ì§€ì›í•©ë‹ˆë‹¤.</div>
        </div>
        <div class="right help hide-m">ì €ì¥: ë¡œì»¬ IndexedDB + Firestore(ë™ê¸°í™”). PDFëŠ” ë¡œì»¬ ì €ì¥ + Firebase Storage ì—…ë¡œë“œ ì‹œë„.</div>
      </div>
    </section>

    <section class="card" id="importer">
      <div class="row">
        <div>
          <label for="excelFile"><strong>1) ì—‘ì…€(.xlsx) ì„ íƒ</strong></label>
          <div class="help">í—¤ë”: PNU, ì†Œìœ ì, ì§€ë²ˆ, í˜‘ì˜ë‚´ìš© ê¶Œì¥(ë§¤í•‘ ì œê³µ). í˜„ì¬ ì‘ì—…ë°©ì— ë°˜ì˜ë©ë‹ˆë‹¤.</div>
        </div>
      </div>
      <div id="mapBox" style="display:none;margin-top:12px">
        <div class="row">
          <div><label>ì—‘ì…€ í—¤ë” â†’ PNU</label><select id="mapPnu"></select></div>
          <div><label>ì—‘ì…€ í—¤ë” â†’ ì†Œìœ ì</label><select id="mapOwner"></select></div>
          <div><label>ì—‘ì…€ í—¤ë” â†’ ì§€ë²ˆ</label><select id="mapLot"></select></div>
          <div><label>ì—‘ì…€ í—¤ë” â†’ í˜‘ì˜ë‚´ìš©</label><select id="mapNote"></select></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnApplyMap" class="btn brand">ë§¤í•‘ ì ìš© & ì €ì¥</button>
          <div class="help">ë™ì¼ PNUëŠ” ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤(ì‘ì—…ë°© ë‚´).</div>
        </div>
      </div>
    </section>

    <section class="card" id="editor">
      <div class="help">â€» ì´ ë²„ì „ì€ <strong>í˜‘ì˜ë‚´ìš©</strong> ìˆ˜ì • + <strong>í•©ì˜ ê²½ê³„</strong> ìš”ì²­/ì²˜ë¦¬ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.</div>
      <div style="overflow:auto">
        <table>
          <colgroup>
            <col class="num"><col class="pnu"><col class="owner"><col class="lot"><col class="note"><col class="sign"><col class="ops">
          </colgroup>
          <thead>
            <tr>
              <th>No.</th>
              <th>PNU</th>
              <th>ì†Œìœ ì</th>
              <th>ì§€ë²ˆ</th>
              <th>í˜‘ì˜ ë‚´ìš©</th>
              <th class="hide-m">ì„œëª…</th>
              <th>ì‘ì—…</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnNew" class="btn accent">+ ì‹ ê·œ</button>
      </div>
    </section>

    <section class="card" id="cloudInfo">
      <strong>ì—¬ëŸ¬ ëª…ì´ í•¨ê»˜ ì“°ê¸°(ì‹¤ì‹œê°„)</strong>
      <div class="help">ê°™ì€ ì‘ì—…ë°©ì— ì ‘ì†í•˜ë©´ ë‚´ìš©ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤. í•©ì˜ìš”ì²­ì€ ìƒëŒ€ PNU í–‰ì— ì¦‰ì‹œ í‘œì‹œë©ë‹ˆë‹¤.</div>
    </section>
  </main>

  <footer>
    <div class="small">â€» ì„œëª… ì´ë¯¸ì§€ëŠ” ë¡œì»¬ DB ë° Firestoreì— Data URL(Base64)ë¡œ ì €ì¥ë©ë‹ˆë‹¤. ë²•ì  ì „ìì„œëª…ì€ ë³„ë„ ì‹œìŠ¤í…œ ì—°ë™ í•„ìš”. ì£¼ë¯¼ë²ˆí˜¸ ì•7ìë¦¬ ë“± ë¯¼ê°ì •ë³´ëŠ” ë‚´ë¶€ ìš©ë„ë¡œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.</div>
  </footer>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <!-- PDF: html2canvas + jsPDF (í•œê¸€ ë Œë”ë§ ì•ˆì „) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- 1) Dexie(IndexedDB) -->
  <script>
  const db = new Dexie('pnu_agreements');
  db.version(1).stores({ records:'pnu', signatures:'pnu' });
  db.version(2).stores({
    workspaces:'name',
    records:'[ws+pnu], ws, pnu',
    signatures:'[ws+pnu], ws, pnu'
  }).upgrade(async tx=>{
    const oldRecs = await tx.table('records').toArray().catch(()=>[]);
    const oldSigs = await tx.table('signatures').toArray().catch(()=>[]);
    if(oldRecs.length || oldSigs.length){
      await tx.table('workspaces').put({ name: 'ê¸°ë³¸' });
      for(const r of oldRecs){ await tx.table('records').put({ ws:'ê¸°ë³¸', pnu:r.pnu, owner:r.owner, lot:r.lot, note:r.note }); }
      for(const s of oldSigs){ await tx.table('signatures').put({ ws:'ê¸°ë³¸', pnu:s.pnu, dataUrl:s.dataUrl, signedAt:s.signedAt }); }
    }else{
      await tx.table('workspaces').put({ name: 'ê¸°ë³¸' });
    }
  });
  db.version(3).stores({
    workspaces:'name',
    records:'[ws+pnu], ws, pnu, updatedAtMs',
    signatures:'[ws+pnu], ws, pnu, updatedAtMs'
  }).upgrade(async tx=>{
    const now = Date.now();
    const recs = await tx.table('records').toArray().catch(()=>[]);
    for (const r of recs) { if (typeof r.updatedAtMs !== 'number') { r.updatedAtMs = now; await tx.table('records').put(r); } }
    const sigs = await tx.table('signatures').toArray().catch(()=>[]);
    for (const s of sigs) { if (typeof s.updatedAtMs !== 'number') { s.updatedAtMs = now; await tx.table('signatures').put(s); } }
  });
  /* v4: í•©ì˜ ê²½ê³„ í…Œì´ë¸” ì¶”ê°€ */
  db.version(4).stores({
    workspaces:'name',
    records:'[ws+pnu], ws, pnu, updatedAtMs',
    signatures:'[ws+pnu], ws, pnu, updatedAtMs',
    agreements:'[ws+agid], ws, agid, fromPnu, toPnu, status, updatedAtMs'
  });
  window.db = db;
  </script>

  <!-- 2) Firebase ì´ˆê¸°í™” -->
  <script type="module" id="firebase-init">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { initializeFirestore } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // >>> ë³¸ì¸ Firebase ì½˜ì†”ì˜ Web êµ¬ì„±ìœ¼ë¡œ êµì²´í•˜ì„¸ìš” <<<
    const firebaseConfig = {
      apiKey: "AIzaSyDh8dyrAbshk0npKTxZAdaX3_426txbRpI",
      authDomain: "jajosa-8d811.firebaseapp.com",
      projectId: "jajosa-8d811",
      storageBucket: "jajosa-8d811.firebasestorage.app",
      messagingSenderId: "616881022512",
      appId: "1:616881022512:web:cf3b8c32f4535bb65a6ff5",
      measurementId: "G-9J5C7KHCZG"
    };

    const PROJECT_ID = 'jajosa-8d811';
    window.__PROJECT_ID = PROJECT_ID;

    const app = initializeApp(firebaseConfig);
    const fdb = initializeFirestore(app, {
      experimentalAutoDetectLongPolling: true,
      useFetchStreams: false,
    });
    window.__fdb = fdb;

    const auth = getAuth(app);

    async function ensureMember() {
      const user = auth.currentUser;
      if (!user) return;
      const { doc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js");
      const mref = doc(fdb, `projects/${PROJECT_ID}/members/${user.uid}`);
      try {
        await setDoc(mref, { role: 'admin', createdAt: new Date().toISOString() }, { merge: true });
      } catch (e) { console.warn('[members bootstrap] ì‹¤íŒ¨:', e); }
    }
    window.__ensureMember = ensureMember;

    window.__authReady = new Promise((resolve, reject) => {
      onAuthStateChanged(auth, async () => {
        try { await ensureMember(); } catch(_) {}
        resolve();
      }, reject);
    });

    signInAnonymously(auth).catch((e) => console.warn('[auth] signInAnonymously ì‹¤íŒ¨', e));
  </script>

  <!-- 3) ë™ê¸°í™” í—¬í¼(IndexedDB â†” Firestore) + Storage ì—…ë¡œë“œ -->
  <script type="module">
    import {
      doc, setDoc, collection, query, onSnapshot, deleteDoc, serverTimestamp, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    const fdbRef = window.__fdb;
    const dbRef  = window.db;
    const PROJECT_ID = window.__PROJECT_ID || 'default';
    const storage = getStorage(); // default app

    const safeId = (s)=> String(s ?? '').replaceAll('/', '_');

    const pnuCol   = () => collection(fdbRef, `projects/${PROJECT_ID}/pnu`);
    const signCol  = () => collection(fdbRef, `projects/${PROJECT_ID}/signatures`);
    const agreeCol = () => collection(fdbRef, `projects/${PROJECT_ID}/agreements`);

    const pnuDocRef   = (ws, pnu) => doc(fdbRef, `projects/${PROJECT_ID}/pnu/${safeId(ws)}__${safeId(pnu)}`);
    const signDocRef  = (ws, pnu) => doc(fdbRef, `projects/${PROJECT_ID}/signatures/${safeId(ws)}__${safeId(pnu)}`);
    const agreeDocRef = (ws, agid)=> doc(fdbRef, `projects/${PROJECT_ID}/agreements/${safeId(ws)}__${safeId(agid)}`);

    let applyingRemote = false;

    async function upsertRecordLocalFirst(rec){
      const now = Date.now();
      await dbRef.records.put({ ...rec, updatedAtMs: now });
      if (applyingRemote) return;
      const remote = { pnu:String(rec.pnu), owner:rec.owner||'', address:rec.lot||'', content:rec.note||'', updatedAt: serverTimestamp() };
      try { await setDoc(pnuDocRef(rec.ws, rec.pnu), remote, { merge:true }); }
      catch (e) { console.warn('[pnu.setDoc] ì‹¤íŒ¨', e); }
    }

    async function upsertSignatureLocalFirst(ws, pnu, dataUrl, signedAtISO=null){
      const now = Date.now();
      await dbRef.signatures.put({ ws, pnu, dataUrl, signedAt:signedAtISO||new Date().toISOString(), updatedAtMs: now });
      if (applyingRemote) return;
      const { getAuth } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js");
      const uid = getAuth().currentUser?.uid || 'unknown';
      const remote = { userId: uid, ws, pnu, signatureUrl: dataUrl, updatedAt: serverTimestamp() };
      try { await setDoc(signDocRef(ws, pnu), remote, { merge:true }); }
      catch (e) { console.warn('[sign.setDoc] ì‹¤íŒ¨', e); }
    }

    async function deleteRecordAndSignatureLocalFirst(ws, pnu){
      await dbRef.transaction('rw', dbRef.records, dbRef.signatures, async ()=>{
        await dbRef.records.delete([ws,pnu]);
        await dbRef.signatures.delete([ws,pnu]);
      });
      if (applyingRemote) return;
      try { await deleteDoc(pnuDocRef(ws, pnu)); }  catch(e){ console.warn('[pnu.delete] ì‹¤íŒ¨', e); }
      try { await deleteDoc(signDocRef(ws, pnu)); } catch(e){ console.warn('[sign.delete] ì‹¤íŒ¨', e); }
    }

    /* === í•©ì˜ ê²½ê³„ ë™ê¸°í™” === */
    async function upsertAgreementLocalFirst(ag){
      const now = Date.now();
      const payload = { ...ag, updatedAtMs: now };
      await dbRef.agreements.put(payload);
      if (applyingRemote) return;
      const remote = { ...payload }; delete remote.updatedAtMs;
      remote.updatedAt = serverTimestamp();
      try { await setDoc(agreeDocRef(ag.ws, ag.agid), remote, { merge:true }); }
      catch (e) { console.warn('[agree.setDoc] ì‹¤íŒ¨', e); }
    }

    async function setAgreementStatusLocalFirst(ws, agid, nextStatus, extra={}){
      const ag = await dbRef.agreements.get([ws, agid]); if(!ag) return;
      const updated = { ...ag, status: nextStatus, ...extra, updatedAtMs: Date.now() };
      await dbRef.agreements.put(updated);
      if (applyingRemote) return;
      const remote = { status: nextStatus, ...extra, updatedAt: serverTimestamp() };
      try { await setDoc(agreeDocRef(ws, agid), remote, { merge:true }); }
      catch (e) { console.warn('[agree.status] ì‹¤íŒ¨', e); }
    }

    async function uploadAgreementPdfAndSaveUrl(ws, agid, blob, filename, field='pdfUrl'){
      try {
        const path = `projects/${PROJECT_ID}/agreements/${safeId(ws)}__${safeId(agid)}/${filename}`;
        const r = sRef(storage, path);
        const snap = await uploadBytes(r, blob, { contentType: 'application/pdf' });
        const url = await getDownloadURL(snap.ref);
        await setAgreementStatusLocalFirst(ws, agid, (await dbRef.agreements.get([ws,agid]))?.status || 'REQUESTED', { [field]: url });
        return url;
      } catch (e){
        console.warn('[storage.upload] ì‹¤íŒ¨:', e);
        return null;
      }
    }

    let unsubRecords=null, unsubSignatures=null, unsubAgreements=null;
    function stopCloudWatch(){
      unsubRecords?.(); unsubRecords=null;
      unsubSignatures?.(); unsubSignatures=null;
      unsubAgreements?.(); unsubAgreements=null;
    }

    function startCloudWatch(wsName){
      stopCloudWatch();

      unsubRecords = onSnapshot(query(pnuCol()), async snap=>{
        applyingRemote = true;
        try{
          for(const ch of snap.docChanges()){
            const data = ch.doc.data();
            const [idWs, idPnu] = (ch.doc.id.split('__')||[]);
            if (!idWs || !idPnu) continue;
            if (idWs !== safeId(wsName)) continue;
            const r = { ws: wsName, pnu: String(data.pnu || idPnu), owner: data.owner || '', lot: data.address || '', note: data.content || '', updatedAtMs: Date.now() };
            if (!r.pnu) continue;
            await dbRef.records.put(r);
          }
        } finally { applyingRemote = false; window.refreshList?.(); }
      });

      unsubSignatures = onSnapshot(query(signCol()), async snap=>{
        applyingRemote = true;
        try{
          for(const ch of snap.docChanges()){
            const [idWs, idPnu] = (ch.doc.id.split('__')||[]);
            if (!idWs || !idPnu) continue;
            if (idWs !== safeId(wsName)) continue;
            const d = ch.doc.data();
            await dbRef.signatures.put({
              ws: wsName, pnu: idPnu, dataUrl: d.signatureUrl || '',
              signedAt: d.updatedAt?.toDate?.()?.toISOString?.() || new Date().toISOString(),
              updatedAtMs: Date.now(),
            });
          }
        } finally { applyingRemote = false; window.refreshList?.(); }
      });

      unsubAgreements = onSnapshot(query(agreeCol()), async snap=>{
        applyingRemote = true;
        try {
          for(const ch of snap.docChanges()){
            const id = ch.doc.id;
            const [idWs, idAgid] = (id.split('__')||[]);
            if (!idWs || !idAgid) continue;
            if (idWs !== safeId(wsName)) continue;
            const d = ch.doc.data();
            const loc = d.loc || {};
            const rec = {
              ws: wsName, agid: idAgid,
              fromPnu: d.fromPnu, toPnu: d.toPnu, status: d.status || 'REQUESTED',
              from: d.from || {}, to: d.to || {}, loc,
              aSigDataUrl: d.aSigDataUrl || '', bSigDataUrl: d.bSigDataUrl || '',
              pdfUrl: d.pdfUrl || '', pdfUrlFinal: d.pdfUrlFinal || '',
              note: d.note || '',
              createdAt: d.createdAt || '', updatedAtMs: Date.now()
            };
            await dbRef.agreements.put(rec);
          }
        } finally { applyingRemote = false; window.refreshList?.(); }
      });
    }

    window.SyncAPI = {
      upsertRecordLocalFirst,
      upsertSignatureLocalFirst,
      deleteRecordAndSignatureLocalFirst,
      upsertAgreementLocalFirst,
      setAgreementStatusLocalFirst,
      uploadAgreementPdfAndSaveUrl,
      startCloudWatch,
      stopCloudWatch,
    };
  </script>

  <!-- 4) ì•± ë¡œì§(UI/CRUD/ì„œëª…/ì—‘ì…€/í•©ì˜ê²½ê³„) -->
  <script>
  window.ResizeObserver = window.ResizeObserver || class { constructor(){ } observe(){ } unobserve(){ } disconnect(){ } };

  const $ = s=>document.querySelector(s);
  const wsSelect=$('#wsSelect');
  const fileInput=$('#excelFile');
  const mapBox=$('#mapBox'); const mapPnu=$('#mapPnu'); const mapOwner=$('#mapOwner'); const mapLot=$('#mapLot'); const mapNote=$('#mapNote'); const btnApplyMap=$('#btnApplyMap');
  const rowsEl=$('#rows'); const qEl=$('#q'); const sortOwnerAscBtn=$('#sortOwnerAsc'); const sortOwnerDescBtn=$('#sortOwnerDesc');

  let excelHeaders=[], excelRows=[], currentQuery='';
  let sortMode='ownerAsc';
  let currentWS=localStorage.getItem('pnu_current_ws')||'ê¸°ë³¸', lastWS=currentWS;

  const WS_PASS="lxì „ë¶ì¬ì¡°ì‚¬ì¶”ì§„ë‹¨";
  function wsKey(ws){ return `ws_authed_${ws}`; }
  async function ensureWorkspaceAuth(ws){
    if(sessionStorage.getItem(wsKey(ws))==='ok') return true;
    const input=prompt(`ì‘ì—…ë°© "${ws}" ì ‘ê·¼ ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.`);
    if(input===null) return false;
    if(input===WS_PASS){ sessionStorage.setItem(wsKey(ws),'ok'); return true; }
    alert('ì•”í˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'); return false;
  }

  function whenSyncReady(timeoutMs = 10000) {
    return new Promise((resolve, reject) => {
      const start = Date.now();
      const iv = setInterval(() => {
        if (window.SyncAPI && window.__fdb) { clearInterval(iv); resolve(); }
        else if (Date.now() - start > timeoutMs) { clearInterval(iv); reject(new Error('SyncAPI load timeout')); }
      }, 50);
    });
  }

  async function startWsWatch(ws) {
    if (window.__authReady)    await window.__authReady;
    if (window.__ensureMember) await window.__ensureMember();
    await whenSyncReady();
    window.SyncAPI.startCloudWatch(ws);
  }

  async function refreshWorkspaces(){
    let list = await db.workspaces.toArray();
    if(!list.find(w=>w.name===currentWS)){
      if(list.length===0){ await db.workspaces.put({name:'ê¸°ë³¸'}); list = await db.workspaces.toArray(); }
      currentWS=list[0]?.name||'ê¸°ë³¸'; localStorage.setItem('pnu_current_ws', currentWS);
    }
    wsSelect.innerHTML = list.map(w=>`<option ${w.name===currentWS?'selected':''} value="${escapeHtml(w.name)}">${escapeHtml(w.name)}</option>`).join('');
  }

  wsSelect.addEventListener('change', async (e)=>{
    const targetWS=e.target.value;
    const ok=await ensureWorkspaceAuth(targetWS);
    if(!ok){ wsSelect.value=lastWS; return; }
    lastWS=targetWS; currentWS=targetWS; localStorage.setItem('pnu_current_ws', currentWS);
    await startWsWatch(currentWS);
    refreshList();
  });

  window.addEventListener('load', async () => {
    try {
      await refreshWorkspaces();
      const ok = await ensureWorkspaceAuth(currentWS);
      if(!ok) return;
      lastWS = currentWS;
      await startWsWatch(currentWS);
      refreshList();
    } catch (e) {
      console.error('[init] SyncAPI not ready:', e);
      alert('ì´ˆê¸°í™” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
    }
  });

  $('#btnAddWs').addEventListener('click', async ()=>{
    const name=prompt('ìƒˆ ì‘ì—…ë°© ì´ë¦„'); if(!name) return;
    const n=name.trim(); if(!n) return;
    if(await db.workspaces.get(n)){ alert('ê°™ì€ ì´ë¦„ì´ ìˆìŠµë‹ˆë‹¤.'); return; }
    await db.workspaces.put({name:n}); await refreshWorkspaces();
    const ok=await ensureWorkspaceAuth(n); if(!ok) return;
    currentWS=n; lastWS=n; localStorage.setItem('pnu_current_ws', currentWS);
    await refreshWorkspaces();
    await whenSyncReady();
    window.SyncAPI.startCloudWatch(currentWS);
    await refreshList();
  });

  $('#btnRenameWs').addEventListener('click', async ()=>{
    const old=currentWS; const neo=prompt(`ì‘ì—…ë°© ì´ë¦„ ë³€ê²½: ${old} â†’`, old);
    if(neo===null) return; const n=neo.trim(); if(!n||n===old) return;
    if(await db.workspaces.get(n)){ alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.'); return; }
    await db.transaction('rw', db.workspaces, db.records, db.signatures, async ()=>{
      await db.workspaces.delete(old); await db.workspaces.put({name:n});
      const recs=await db.records.where('ws').equals(old).toArray();
      for(const r of recs){ await db.records.delete([old,r.pnu]); await db.records.put({...r, ws:n}); }
      const sigs=await db.signatures.where('ws').equals(old).toArray();
      for(const s of sigs){ await db.signatures.delete([old,s.pnu]); await db.signatures.put({...s, ws:n}); }
    });
    const ok=await ensureWorkspaceAuth(n); if(!ok) return;
    currentWS=n; lastWS=n; localStorage.setItem('pnu_current_ws', currentWS);
    await refreshWorkspaces();
    await startWsWatch(currentWS);
    await refreshList();
  });

  $('#btnDelWs').addEventListener('click', async ()=>{
    const name=currentWS; const list=await db.workspaces.toArray();
    if(list.length<=1){ alert('ìµœì†Œ 1ê°œ ì‘ì—…ë°© í•„ìš”'); return; }
    if(!confirm(`"${name}" ì‚­ì œ? (ë³µêµ¬ ë¶ˆê°€)`)) return;
    await db.transaction('rw', db.workspaces, db.records, db.signatures, async ()=>{
      await db.workspaces.delete(name);
      const recs=await db.records.where('ws').equals(name).toArray();
      for(const r of recs){ await db.records.delete([name,r.pnu]); }
      const sigs=await db.signatures.where('ws').equals(name).toArray();
      for(const s of sigs){ await db.signatures.delete([name,s.pnu]); }
    });
    const remain=await db.workspaces.toArray();
    currentWS=remain[0].name; lastWS=currentWS; localStorage.setItem('pnu_current_ws', currentWS);
    await refreshWorkspaces();
    await whenSyncReady();
    window.SyncAPI.startCloudWatch(currentWS);
    await refreshList();
  });

  $('#btnLockWs').addEventListener('click', ()=>{
    sessionStorage.removeItem(wsKey(currentWS));
    alert('ì´ ì‘ì—…ë°©ì˜ ì¸ì¦ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì ‘ê·¼ ì‹œ ì•”í˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
  });

  fileInput.addEventListener('change', async e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const {headers,rows}=await parseExcel(f);
    excelHeaders=headers; excelRows=rows; buildMappingSelects(headers);
    mapBox.style.display='block';
  });
  function buildMappingSelects(headers){
    const fill=(sel, guess=[])=>{
      sel.innerHTML='<option value="">(ì‚¬ìš© ì•ˆí•¨)</option>'+headers.map((h,i)=>`<option value="${i}">${escapeHtml(h)}</option>`).join('');
      for(const g of guess){ const idx=headers.findIndex(h=>h.toLowerCase().includes(g)); if(idx>=0){ sel.value=String(idx); break; } }
    };
    fill(mapPnu,   ['pnu','í•„ì§€','ê³ ìœ ','parcel']);
    fill(mapOwner, ['ì†Œìœ ','owner','ì„±ëª…','ì´ë¦„','ëŒ€í‘œ']);
    fill(mapLot,   ['ì§€ë²ˆ','ì£¼ì†Œ','lot','parcel','address']);
    fill(mapNote,  ['í˜‘ì˜','ë‚´ìš©','ë¹„ê³ ','note','memo']);
  }
  $('#btnApplyMap').addEventListener('click', async ()=>{
    if(!excelRows.length){ alert('ì—‘ì…€ì„ ë¨¼ì € ë¶ˆëŸ¬ì˜¤ì„¸ìš”.'); return; }
    const idx={ pnu:parseInt(mapPnu.value,10), owner:parseInt(mapOwner.value,10), lot:parseInt(mapLot.value,10), note:parseInt(mapNote.value,10) };
    if(Number.isNaN(idx.pnu)) { alert('PNU ë§¤í•‘ì€ í•„ìˆ˜'); return; }
    let upserted=0;
    await db.transaction('rw', db.records, async ()=>{
      for(const row of excelRows){
        const rec={ ws:currentWS, pnu:normalizePnu(cell(row,idx.pnu)), owner:cell(row,idx.owner), lot:cell(row,idx.lot), note:cell(row,idx.note) };
        if(!rec.pnu) continue;
        await db.records.put({ ...rec, updatedAtMs: Date.now() });
        upserted++;
      }
    });

    const allJustSaved = await db.records.where('ws').equals(currentWS).toArray();
    allJustSaved.forEach(r=>{
      window.SyncAPI?.upsertRecordLocalFirst(r);
    });

    alert(`(${currentWS}) ${upserted.toLocaleString()}ê±´ ì €ì¥/ê°±ì‹ `);
    mapBox.style.display='none'; fileInput.value=''; refreshList();
  });
  async function parseExcel(file){
    const data=await file.arrayBuffer();
    const wb=XLSX.read(data,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{header:1, defval:''});
    const headers=rows.shift()?.map(String)??[];
    return {headers, rows};
  }
  function cell(row, idx){ if(Number.isNaN(idx)) return ''; return (row?.[idx]??'').toString().trim(); }
  function normalizePnu(v){ if(!v) return ''; return String(v).replace(/\s+/g,'').replace(/[^0-9-]/g,''); }

  qEl.addEventListener('input', e=>{ currentQuery=e.target.value; refreshList(); });
  sortOwnerAscBtn.addEventListener('click', ()=>{ sortMode='ownerAsc'; refreshList(); });
  sortOwnerDescBtn.addEventListener('click', ()=>{ sortMode='ownerDesc'; refreshList(); });

  async function refreshList(){
    const all=await db.records.where('ws').equals(currentWS).toArray();
    const sigs=await db.signatures.where('ws').equals(currentWS).toArray();
    const sigMap=new Map(sigs.map(s=>[s.pnu,s]));

    // í•©ì˜ìš”ì²­ ì¹´ìš´íŠ¸(í•´ë‹¹ PNUê°€ ìˆ˜ì‹ ì(toPnu)ì¸ REQUESTED)
    const ags = await db.agreements.where('ws').equals(currentWS).toArray();
    const pendingCountMap = new Map();
    for(const a of ags){ if(a.status==='REQUESTED'){ pendingCountMap.set(a.toPnu, (pendingCountMap.get(a.toPnu)||0)+1); } }

    const q=currentQuery.trim().toLowerCase();
    let filtered = q
      ? all.filter(r => r.pnu.toLowerCase().includes(q) || (r.owner||'').toLowerCase().includes(q) || (r.lot||'').toLowerCase().includes(q))
      : all;

    if(sortMode==='ownerAsc') filtered.sort((a,b)=>(a.owner||'').localeCompare(b.owner||'','ko'));
    else if(sortMode==='ownerDesc') filtered.sort((a,b)=>(b.owner||'').localeCompare(a.owner||'','ko'));
    else filtered.sort((a,b)=>a.pnu.localeCompare(b.pnu));

    rowsEl.innerHTML = filtered.map((r, i)=>{
      const s=sigMap.get(r.pnu); const signed=!!s?.dataUrl;
      const when=s?.signedAt?new Date(s.signedAt).toLocaleString():'';      
      const pnuEnc=encodeURIComponent(r.pnu);
      const cnt = pendingCountMap.get(r.pnu)||0;
      const reqBtn = cnt>0 ? `<button class="btn danger btn-incoming" title="ë°›ì€ í•©ì˜ìš”ì²­ ì²˜ë¦¬" data-pnu="${pnuEnc}">ğŸ“¬ ìš”ì²­ì²˜ë¦¬(${cnt})</button>` : '';
      return `<tr>
        <td title="${i+1}">${i+1}</td>
        <td title="${escapeHtml(r.pnu)}"><span class="small muted">#</span> ${escapeHtml(r.pnu)}</td>
        <td title="${escapeHtml(r.owner||'')}">${escapeHtml(r.owner||'')}</td>
        <td title="${escapeHtml(r.lot||'')}">${escapeHtml(r.lot||'')}</td>
        <td title="${escapeHtml((r.note||'').replace(/\n/g,' '))}">${escapeHtml(r.note||'')}</td>
        <td class="hide-m">${signed?`<span class="pill ok">ì„œëª…</span><div class="small muted">${escapeHtml(when)}</div>`:`<span class="pill no">ë¯¸ì„œëª…</span>`}</td>
        <td>
          <div class="row" style="gap:6px">
            <button class="btn btn-edit" data-pnu="${pnuEnc}">âœï¸ í˜‘ì˜ë‚´ìš©</button>
            <button class="btn accent btn-sign" data-pnu="${pnuEnc}">âœï¸ ì„œëª…(ì—…ë¡œë“œ/ì§ì ‘)</button>
            <button class="btn btn-preview" data-pnu="${pnuEnc}">ğŸ–¼ï¸ ì„œëª…ë³´ê¸°</button>
            <button class="btn brand btn-agree" data-pnu="${pnuEnc}">ğŸ¤ í•©ì˜ ê²½ê³„</button>
            ${reqBtn}
            <button class="btn danger btn-del" data-pnu="${pnuEnc}">ğŸ—‘ï¸ ì‚­ì œ</button>
          </div>
        </td>
      </tr>`;
    }).join('');
  }
  window.refreshList = refreshList;

  $('#btnNew').addEventListener('click', async ()=>{
    const pnu=prompt(`[${currentWS}] ì‹ ê·œ PNU(ê³ ìœ í‚¤)`); if(pnu===null) return;
    const key=normalizePnu(pnu); if(!key){ alert('PNUëŠ” í•„ìˆ˜'); return; }
    const owner=prompt('ì†Œìœ ì:')??''; const lot=prompt('ì§€ë²ˆ:')??'';
    await window.SyncAPI.upsertRecordLocalFirst({ws:currentWS, pnu:key, owner:owner.trim(), lot:lot.trim(), note:''});
    openNoteModal(key,'');
  });

  rowsEl.addEventListener('click', async e=>{
    const btn=e.target.closest('button'); if(!btn) return;
    const pnu=decodeURIComponent(btn.dataset.pnu||''); if(!pnu) return;

    if(btn.classList.contains('btn-edit')){
      const rec=await db.records.get([currentWS,pnu]);
      if(!rec){ alert('ë ˆì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      openNoteModal(pnu, rec.note||'');
    }else if(btn.classList.contains('btn-sign')){
      openSignModal(pnu);
    }else if(btn.classList.contains('btn-preview')){
      const s=await db.signatures.get([currentWS,pnu]);
      if(!s?.dataUrl){ alert('ì„œëª…ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const win=window.open(); win.document.write(`<img alt="signature" src="${s.dataUrl}">`);
    }else if(btn.classList.contains('btn-agree')){
      openAgreeModal(pnu); // í•©ì˜ ê²½ê³„ ì‘ì„±(Aì¸¡)
    }else if(btn.classList.contains('btn-incoming')){
      openIncomingModal(pnu); // ìˆ˜ì‹  í•©ì˜ìš”ì²­ ëª©ë¡(Bì¸¡)
    }else if(btn.classList.contains('btn-del')){
      if(!confirm(`ì‚­ì œí• ê¹Œìš”?\n[${currentWS}] PNU: ${pnu}`)) return;
      await window.SyncAPI.deleteRecordAndSignatureLocalFirst(currentWS, pnu);
      refreshList();
    }
  });

  /* ---------- í˜‘ì˜ë‚´ìš© ëª¨ë‹¬ ---------- */
  let noteModal, noteTextarea, noteSaveBtn, noteCloseBtn, notePnuLabel, notePnu='';
  function ensureNoteModal(){
    if(noteModal) return;
    noteModal=document.createElement('div'); noteModal.className='modal';
    noteModal.innerHTML=`
      <div class="sheet">
        <div class="row" style="align-items:center">
          <h3 style="margin:0">í˜‘ì˜ ë‚´ìš©</h3><span class="right"></span>
          <button class="btn" id="btnCloseNote">ë‹«ê¸°</button>
        </div>
        <div class="help" id="noteTarget" style="margin:6px 0 10px"></div>
        <textarea id="noteTextarea" rows="10" placeholder="í˜‘ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”(ì¤„ë°”ê¿ˆ ê°€ëŠ¥)"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn brand" id="btnSaveNote">ì €ì¥</button>
        </div>
      </div>`;
    document.body.appendChild(noteModal);
    noteTextarea=noteModal.querySelector('#noteTextarea');
    noteSaveBtn=noteModal.querySelector('#btnSaveNote');
    noteCloseBtn=noteModal.querySelector('#btnCloseNote');
    notePnuLabel=noteModal.querySelector('#noteTarget');

    noteCloseBtn.addEventListener('click', ()=> noteModal.classList.remove('open'));
    noteSaveBtn.addEventListener('click', async ()=>{
      const rec=await db.records.get([currentWS, notePnu]);
      if(!rec){ alert('ë ˆì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      await window.SyncAPI.upsertRecordLocalFirst({ ...rec, note: (noteTextarea.value||'').trim() });
      noteModal.classList.remove('open'); refreshList();
    });
  }
  function openNoteModal(pnu, note){
    ensureNoteModal(); notePnu=pnu;
    notePnuLabel.textContent=`[${currentWS}] PNU ${pnu}`;
    noteTextarea.value=note||''; noteModal.classList.add('open'); noteTextarea.focus();
  }

  /* ---------- ì„œëª… ëª¨ë‹¬ ---------- */
  let sigModal, tabUploadBtn, tabDrawBtn, upFile, upPreview, drawCanvas, drawPad, clearDrawBtn, saveSigBtn, closeSigBtn, sigPnuLabel, sigPnu='';
  function ensureSignModal(){
    if(sigModal) return;
    sigModal=document.createElement('div'); sigModal.className='modal';
    sigModal.innerHTML=`
      <div class="sheet">
        <div class="row" style="align-items:center">
          <h3 style="margin:0">ì„œëª… (PNG ì—…ë¡œë“œ ë˜ëŠ” ì§ì ‘ ì„œëª…)</h3><span class="right"></span>
          <button class="btn" id="btnCloseSig">ë‹«ê¸°</button>
        </div>
        <div class="help" id="sigTarget" style="margin:6px 0 10px"></div>
        <div class="tabs"><button class="btn" id="tabUpload">PNG ì—…ë¡œë“œ</button><button class="btn" id="tabDraw">ì§ì ‘ ì„œëª…</button></div>
        <div id="paneUpload">
          <input id="upFile" type="file" accept="image/png">
          <div style="margin-top:10px"><img id="upPreview" alt="ë¯¸ë¦¬ë³´ê¸°" style="max-width:100%;border-radius:8px;display:none"></div>
        </div>
        <div id="paneDraw" style="display:none; margin-top:8px">
          <canvas id="drawCanvas"></canvas>
          <div class="row" style="margin-top:8px"><button class="btn" id="btnClearDraw">ì§€ìš°ê¸°</button></div>
          <div class="help">í„°ì¹˜/íœ/ë§ˆìš°ìŠ¤ë¡œ ì„œëª…í•˜ì„¸ìš”.</div>
        </div>
        <div class="row" style="margin-top:12px"><button class="btn brand" id="btnSaveSig">ì €ì¥</button></div>
      </div>`;
    document.body.appendChild(sigModal);
    tabUploadBtn = sigModal.querySelector('#tabUpload'); tabDrawBtn   = sigModal.querySelector('#tabDraw');
    upFile       = sigModal.querySelector('#upFile');    upPreview    = sigModal.querySelector('#upPreview');
    drawCanvas   = sigModal.querySelector('#drawCanvas'); clearDrawBtn= sigModal.querySelector('#btnClearDraw');
    saveSigBtn   = sigModal.querySelector('#btnSaveSig'); closeSigBtn = sigModal.querySelector('#btnCloseSig');
    sigPnuLabel  = sigModal.querySelector('#sigTarget');

    tabUploadBtn.addEventListener('click', ()=>{ showPane('upload'); });
    tabDrawBtn.addEventListener('click',   ()=>{ showPane('draw'); resizeDrawCanvas(); drawPad?.clear(); });
    upFile.addEventListener('change', ()=>{
      const f=upFile.files?.[0];
      if(!f){ upPreview.style.display='none'; return; }
      if(f.type!=='image/png'){ alert('PNG í˜•ì‹ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); upFile.value=''; upPreview.style.display='none'; return; }
      const reader=new FileReader();
      reader.onload=ev=>{ upPreview.src=ev.target.result; upPreview.style.display='block'; };
      reader.readAsDataURL(f);
    });
    drawPad = new window.SignaturePad(drawCanvas, { backgroundColor:'white', penColor:'black' });
    clearDrawBtn.addEventListener('click', ()=> drawPad.clear());
    closeSigBtn.addEventListener('click', ()=> sigModal.classList.remove('open'));
    saveSigBtn.addEventListener('click', async ()=>{
      let dataUrl=''; const f=upFile.files?.[0];
      if(f){ if(f.type!=='image/png'){ alert('PNG í˜•ì‹ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }
        dataUrl = upPreview.src || await fileToDataURL(f);
      }else{ if(drawPad.isEmpty()){ alert('ì„œëª…ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.'); return; }
        dataUrl = drawPad.toDataURL('image/png');
      }
      await window.SyncAPI.upsertSignatureLocalFirst(currentWS, sigPnu, dataUrl);
      sigModal.classList.remove('open'); upFile.value=''; upPreview.style.display='none'; drawPad.clear();
      refreshList();
    });
    const ro=new ResizeObserver(resizeDrawCanvas); ro.observe(drawCanvas);
    window.addEventListener('orientationchange', ()=> setTimeout(resizeDrawCanvas, 300));
  }
  function showPane(which){
    const upPane=sigModal.querySelector('#paneUpload');
    const drawPane=sigModal.querySelector('#paneDraw');
    if(which==='upload'){ upPane.style.display='block'; drawPane.style.display='none'; }
    else { upPane.style.display='none'; drawPane.style.display='block'; }
  }
  function resizeDrawCanvas(){
    const ratio=Math.max(window.devicePixelRatio||1,1);
    const rect=drawCanvas.getBoundingClientRect();
    drawCanvas.width=rect.width*ratio; drawCanvas.height=220*ratio; const ctx=drawCanvas.getContext('2d'); ctx.scale(ratio,ratio);
  }
  async function fileToDataURL(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.onerror=rej; r.readAsDataURL(f); }); }
  async function openSignModal(pnu){
    ensureSignModal(); sigPnu=pnu;
    const rec=await db.records.get([currentWS, pnu]); if(!rec){ alert('ë ˆì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
    sigPnuLabel.textContent=`[${currentWS}] PNU ${rec.pnu} Â· ${rec.owner||''} Â· ${rec.lot||''}`;
    showPane('upload'); upFile.value=''; upPreview.style.display='none'; drawPad.clear();
    sigModal.classList.add('open'); setTimeout(resizeDrawCanvas, 50);
  }

  /* ---------- í•©ì˜ ê²½ê³„: Aì¸¡ ì‘ì„± ëª¨ë‹¬ ---------- */
  let agreeModal, aSigPad, aCanvas, agreeSaveBtn, agreeCloseBtn, toPnuInput, toPnuList, draftPdfBtn;
  function ensureAgreeModal(){
    if(agreeModal) return;
    agreeModal=document.createElement('div'); agreeModal.className='modal';
    agreeModal.innerHTML=`
      <div class="sheet">
        <div class="row" style="align-items:center">
          <h3 style="margin:0">ğŸ¤ í•©ì˜ ê²½ê³„ â€” ìš”ì²­ ì‘ì„±</h3><span class="right"></span>
          <button class="btn" id="btnCloseAgree">ë‹«ê¸°</button>
        </div>
        <div class="help" id="agreeHeader" style="margin:6px 0 10px"></div>

        <div class="grid2">
          <div>
            <label>ìƒëŒ€ PNU(ê²€ìƒ‰/ì„ íƒ)</label>
            <input list="pnuList" id="toPnuInput" placeholder="ìƒëŒ€ PNU ì…ë ¥" />
            <datalist id="pnuList"></datalist>
          </div>
          <div>
            <label>í•©ì˜ ìœ„ì¹˜(ë©´/ë™/ë¦¬/ì§€ë²ˆ)</label>
            <input id="locMdrj" placeholder="ì˜ˆ: â—‹â—‹ë©´ â—‹â—‹ë¦¬ â—‹â—‹-â—‹" />
          </div>
          <div>
            <label>A(ìš”ì²­ì) ì†Œìœ ìëª…</label>
            <input id="aName" />
          </div>
          <div>
            <label>A ìƒë…„ì›”ì¼(ì• 7ìë¦¬)</label>
            <input id="aDob7" placeholder="YYMMDDX" />
          </div>
          <div>
            <label>A ì£¼ì†Œ</label>
            <input id="aAddr" />
          </div>
          <div>
            <label>B(ìƒëŒ€) ì†Œìœ ìëª…</label>
            <input id="bName" />
          </div>
          <div>
            <label>B ìƒë…„ì›”ì¼(ì• 7ìë¦¬)</label>
            <input id="bDob7" placeholder="YYMMDDX" />
          </div>
          <div>
            <label>B ì£¼ì†Œ</label>
            <input id="bAddr" />
          </div>
        </div>

        <div class="line"></div>

        <label>í˜‘ì˜ ë‚´ìš©(ìš”ì§€)</label>
        <textarea id="agreeNote" rows="5" placeholder="í•©ì˜ ê²½ê³„ì— ëŒ€í•œ ìš”ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>

        <div class="line"></div>

        <div>
          <label>A ì„œëª…</label>
          <canvas id="aSignCanvas"></canvas>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="btnClearASign">ì§€ìš°ê¸°</button>
            <span class="right"></span>
            <button class="btn brand" id="btnSaveAgree">ìš”ì²­ ì €ì¥(REQUESTED)</button>
          </div>
          <div class="help">ì €ì¥ ì‹œ ìƒëŒ€ PNU í–‰ì— ğŸ“¬ í•©ì˜ìš”ì²­ í‘œì‹œê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>
        </div>
      </div>`;
    document.body.appendChild(agreeModal);

    aCanvas = agreeModal.querySelector('#aSignCanvas');
    aSigPad = new window.SignaturePad(aCanvas, { backgroundColor:'white', penColor:'black' });
    const ro=new ResizeObserver(()=>resizeCanvas(aCanvas,200)); ro.observe(aCanvas);
    agreeCloseBtn = agreeModal.querySelector('#btnCloseAgree');
    agreeSaveBtn  = agreeModal.querySelector('#btnSaveAgree');
    toPnuInput    = agreeModal.querySelector('#toPnuInput');
    toPnuList     = agreeModal.querySelector('#pnuList');

    agreeModal.querySelector('#btnClearASign').addEventListener('click', ()=> aSigPad.clear());
    agreeCloseBtn.addEventListener('click', ()=> agreeModal.classList.remove('open'));
    agreeSaveBtn.addEventListener('click', saveAgreementRequest);
  }

  let agreeFromPnu='';
  async function openAgreeModal(fromPnu){
    ensureAgreeModal();
    agreeFromPnu = fromPnu;
    // datalist ì±„ìš°ê¸°
    const list = await db.records.where('ws').equals(currentWS).toArray();
    toPnuList.innerHTML = list.map(r=>`<option value="${escapeHtml(r.pnu)}">${escapeHtml(r.pnu)} Â· ${escapeHtml(r.owner||'')} Â· ${escapeHtml(r.lot||'')}</option>`).join('');

    // Aì¸¡ ìë™ ì±„ìš°ê¸°
    const recA = await db.records.get([currentWS, fromPnu]);
    agreeModal.querySelector('#agreeHeader').textContent = `[${currentWS}] ìš”ì²­ì PNU ${fromPnu} Â· ${recA?.owner||''} Â· ${recA?.lot||''}`;
    agreeModal.querySelector('#aName').value = recA?.owner || '';
    agreeModal.querySelector('#aAddr').value = recA?.lot || '';
    agreeModal.querySelector('#aDob7').value = '';

    // Bì¸¡ ì´ˆê¸°í™”
    agreeModal.querySelector('#toPnuInput').value = '';
    agreeModal.querySelector('#bName').value = '';
    agreeModal.querySelector('#bDob7').value = '';
    agreeModal.querySelector('#bAddr').value = '';
    agreeModal.querySelector('#locMdrj').value = '';
    agreeModal.querySelector('#agreeNote').value = '';
    aSigPad.clear();

    // toPnu ì„ íƒ ì‹œ B ìë™ ì±„ì›€
    agreeModal.querySelector('#toPnuInput').onchange = async (e)=>{
      const p = normalizePnu(e.target.value||'');
      if(!p) return;
      const recB = await db.records.get([currentWS, p]);
      if(recB){
        agreeModal.querySelector('#bName').value = recB.owner||'';
        agreeModal.querySelector('#bAddr').value = recB.lot||'';
      }
    };

    agreeModal.classList.add('open');
    setTimeout(()=>resizeCanvas(aCanvas,200), 50);
  }

  function resizeCanvas(cvs, h=200){
    const ratio=Math.max(window.devicePixelRatio||1,1);
    const rect=cvs.getBoundingClientRect();
    cvs.width=rect.width*ratio; cvs.height=h*ratio; const ctx=cvs.getContext('2d'); ctx.scale(ratio,ratio);
  }

  function genAgid(){ const d=new Date(); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}_${Math.random().toString(36).slice(2,6)}`; }

  async function saveAgreementRequest(){
    const toPnu = normalizePnu(toPnuInput.value||'');
    if(!toPnu){ alert('ìƒëŒ€ PNUë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
    if(aSigPad.isEmpty()){ alert('A ì„œëª…ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }

    const aName = agreeModal.querySelector('#aName').value.trim();
    const aDob7 = agreeModal.querySelector('#aDob7').value.trim();
    const aAddr = agreeModal.querySelector('#aAddr').value.trim();
    const bName = agreeModal.querySelector('#bName').value.trim();
    const bDob7 = agreeModal.querySelector('#bDob7').value.trim();
    const bAddr = agreeModal.querySelector('#bAddr').value.trim();
    const locMdrj = agreeModal.querySelector('#locMdrj').value.trim();
    const note = (agreeModal.querySelector('#agreeNote').value||'').trim();

    const ag = {
      ws: currentWS,
      agid: genAgid(),
      fromPnu: agreeFromPnu,
      toPnu,
      status: 'REQUESTED',
      from: { name: aName, dob7: aDob7, addr: aAddr },
      to:   { name: bName, dob7: bDob7, addr: bAddr },
      loc:  { mdrj: locMdrj },
      aSigDataUrl: aSigPad.toDataURL('image/png'),
      bSigDataUrl: '',
      note, createdAt: new Date().toISOString(),
    };

    await window.SyncAPI.upsertAgreementLocalFirst(ag);
    // ìš”ì²­ PDF(ì´ˆì•ˆ) ìƒì„± ë° ì—…ë¡œë“œ ì‹œë„
    const blob = await buildAgreementPdfBlob(ag, /*final=*/false);
    const filename = `agreement_${ag.agid}_REQUESTED.pdf`;
    const url = await window.SyncAPI.uploadAgreementPdfAndSaveUrl(currentWS, ag.agid, blob, filename, 'pdfUrl');
    if(!url){ saveAs(blob, filename); } // ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ì €ì¥

    agreeModal.classList.remove('open');
    alert('í•©ì˜ìš”ì²­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒëŒ€ PNUì— ğŸ“¬ í‘œì‹œê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.');
    refreshList();
  }

  /* ---------- í•©ì˜ ê²½ê³„: Bì¸¡ ìˆ˜ì‹ /ì²˜ë¦¬ ëª¨ë‹¬ ---------- */
  let incomingModal, incomingListEl;
  function ensureIncomingModal(){
    if(incomingModal) return;
    incomingModal=document.createElement('div'); incomingModal.className='modal';
    incomingModal.innerHTML=`
      <div class="sheet">
        <div class="row" style="align-items:center">
          <h3 style="margin:0">ğŸ“¬ ë°›ì€ í•©ì˜ìš”ì²­</h3><span class="right"></span>
          <button class="btn" id="btnCloseIncoming">ë‹«ê¸°</button>
        </div>
        <div class="help" id="incomingHead" style="margin:6px 0 10px"></div>
        <div id="incomingList"></div>
      </div>`;
    document.body.appendChild(incomingModal);
    incomingListEl = incomingModal.querySelector('#incomingList');
    incomingModal.querySelector('#btnCloseIncoming').addEventListener('click', ()=> incomingModal.classList.remove('open'));
  }

  async function openIncomingModal(pnu){
    ensureIncomingModal();
    incomingModal.querySelector('#incomingHead').textContent = `[${currentWS}] PNU ${pnu} ìˆ˜ì‹  í•­ëª©`;
    const list = await db.agreements.where('ws').equals(currentWS).toArray();
    const items = list.filter(a=> a.toPnu===pnu && a.status==='REQUESTED');
    if(!items.length){ incomingListEl.innerHTML = `<div class="help">ëŒ€ê¸° ì¤‘ì¸ í•©ì˜ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`; }
    else{
      incomingListEl.innerHTML = items.map(a=>{
        const when = new Date(a.createdAt||Date.now()).toLocaleString();
        return `<div class="card" style="margin-bottom:8px">
          <div><b>ìš”ì²­ID:</b> ${escapeHtml(a.agid)}</div>
          <div class="small muted">${escapeHtml(when)} Â· from ${escapeHtml(a.fromPnu)} â†’ to ${escapeHtml(a.toPnu)}</div>
          <div class="small">A: ${escapeHtml(a.from?.name||'')} / B: ${escapeHtml(a.to?.name||'')}</div>
          <div class="row" style="margin-top:8px">
            <button class="btn brand" data-agid="${a.agid}" data-action="review">ê²€í†  ë° ì„œëª…</button>
            <button class="btn danger" data-agid="${a.agid}" data-action="reject">ë°˜ë ¤</button>
          </div>
        </div>`;
      }).join('');
      incomingListEl.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const agid = btn.dataset.agid;
          const action = btn.dataset.action;
          if(action==='reject'){
            if(confirm('ì´ ìš”ì²­ì„ ë°˜ë ¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
              await window.SyncAPI.setAgreementStatusLocalFirst(currentWS, agid, 'REJECTED');
              alert('ë°˜ë ¤ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
              openIncomingModal(pnu); refreshList();
            }
          }else if(action==='review'){
            openFinalizeModal(agid, pnu);
          }
        });
      });
    }
    incomingModal.classList.add('open');
  }

  /* ---------- í•©ì˜ ê²½ê³„: ìµœì¢… ì„œëª… ëª¨ë‹¬(Bì¸¡ ì„œëª…) ---------- */
  let finModal, bCanvas, bPad, finCloseBtn, finApproveBtn, finInfoBox;
  function ensureFinalizeModal(){
    if(finModal) return;
    finModal=document.createElement('div'); finModal.className='modal';
    finModal.innerHTML=`
      <div class="sheet">
        <div class="row" style="align-items:center">
          <h3 style="margin:0">ìµœì¢… ê²€í†  ë° B ì„œëª…</h3><span class="right"></span>
          <button class="btn" id="btnCloseFin">ë‹«ê¸°</button>
        </div>
        <div id="finInfo" class="help" style="margin:6px 0 10px"></div>
        <div><label>B ì„œëª…</label><canvas id="bSignCanvas"></canvas></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="btnClearB">ì§€ìš°ê¸°</button>
          <span class="right"></span>
          <button class="btn brand" id="btnApprove">ë™ì˜í•˜ê³  ì„œëª…(AGREED)</button>
        </div>
      </div>`;
    document.body.appendChild(finModal);
    finInfoBox = finModal.querySelector('#finInfo');
    bCanvas = finModal.querySelector('#bSignCanvas');
    bPad = new window.SignaturePad(bCanvas, { backgroundColor:'white', penColor:'black' });
    const ro=new ResizeObserver(()=>resizeCanvas(bCanvas,200)); ro.observe(bCanvas);
    finCloseBtn = finModal.querySelector('#btnCloseFin');
    finApproveBtn = finModal.querySelector('#btnApprove');
    finModal.querySelector('#btnClearB').addEventListener('click', ()=> bPad.clear());
    finCloseBtn.addEventListener('click', ()=> finModal.classList.remove('open'));
  }

  async function openFinalizeModal(agid, toPnu){
    ensureFinalizeModal();
    const ag = await db.agreements.get([currentWS, agid]);
    if(!ag){ alert('í•©ì˜ìš”ì²­ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); return; }
    finInfoBox.textContent = `ìš”ì²­ID ${ag.agid} Â· ìœ„ì¹˜ ${ag.loc?.mdrj||''} Â· A:${ag.from?.name||''} Â· B:${ag.to?.name||''}`;
    bPad.clear();
    finApproveBtn.onclick = async ()=>{
      if(bPad.isEmpty()){ alert('B ì„œëª…ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
      const dataUrl = bPad.toDataURL('image/png');
      await window.SyncAPI.setAgreementStatusLocalFirst(currentWS, agid, 'AGREED', { bSigDataUrl: dataUrl });

      // ìµœì¢… PDF ìƒì„±
      const updated = await db.agreements.get([currentWS, agid]);
      const blob = await buildAgreementPdfBlob(updated, /*final=*/true);
      const filename = `agreement_${agid}_AGREED.pdf`;
      const url = await window.SyncAPI.uploadAgreementPdfAndSaveUrl(currentWS, agid, blob, filename, 'pdfUrlFinal');
      if(!url){ saveAs(blob, filename); } // ì—…ë¡œë“œ ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ì €ì¥

      alert('ìµœì¢… ì„œëª…/ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      finModal.classList.remove('open');
      openIncomingModal(toPnu);
      refreshList();
    };
    finModal.classList.add('open');
    setTimeout(()=>resizeCanvas(bCanvas,200), 50);
  }

  /* ---------- PDF ë¹Œë” (html2canvas + jsPDF) ---------- */
  async function buildAgreementPdfBlob(ag, isFinal){
    const mount = document.createElement('div');
    mount.style.position='fixed'; mount.style.left='-9999px'; mount.style.top='0';
    mount.style.width='794px'; /* A4 width @96dpi approx */ mount.style.background='white'; mount.style.color='black';
    mount.style.padding='24px'; mount.style.fontFamily='Pretendard, Noto Sans KR, Arial, sans-serif';
    mount.innerHTML = `
      <div style="border:2px solid #222; padding:16px; border-radius:8px;">
        <h2 style="margin:0 0 8px 0; text-align:center;">ì¬ì¡°ì‚¬ í•©ì˜ ê²½ê³„ì„œ</h2>
        <div style="text-align:center; font-size:12px; color:#444;">ìš”ì²­ID: ${escapeHtml(ag.agid)} Â· ìƒíƒœ: ${escapeHtml(ag.status)} Â· ìƒì„±: ${new Date(ag.createdAt||Date.now()).toLocaleString()}</div>
        <hr style="margin:12px 0">
        <table style="width:100%; border-collapse:collapse; font-size:14px;">
          <tr>
            <td style="border:1px solid #999; padding:8px; width:20%; background:#f6f6f6;">ìœ„ì¹˜(ë©´/ë™/ë¦¬/ì§€ë²ˆ)</td>
            <td style="border:1px solid #999; padding:8px;">${escapeHtml(ag.loc?.mdrj||'')}</td>
          </tr>
          <tr>
            <td style="border:1px solid #999; padding:8px; background:#f6f6f6;">A PNU</td>
            <td style="border:1px solid #999; padding:8px;">${escapeHtml(ag.fromPnu)}</td>
          </tr>
          <tr>
            <td style="border:1px solid #999; padding:8px; background:#f6f6f6;">B PNU</td>
            <td style="border:1px solid #999; padding:8px;">${escapeHtml(ag.toPnu)}</td>
          </tr>
        </table>

        <div style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <div style="border:1px solid #999; padding:8px;">
            <div style="font-weight:700; margin-bottom:6px;">A(ìš”ì²­ì)</div>
            <div>ì„±ëª…: ${escapeHtml(ag.from?.name||'')}</div>
            <div>ìƒë…„ì›”ì¼(7): ${escapeHtml(ag.from?.dob7||'')}</div>
            <div>ì£¼ì†Œ: ${escapeHtml(ag.from?.addr||'')}</div>
          </div>
          <div style="border:1px solid #999; padding:8px;">
            <div style="font-weight:700; margin-bottom:6px;">B(ìƒëŒ€)</div>
            <div>ì„±ëª…: ${escapeHtml(ag.to?.name||'')}</div>
            <div>ìƒë…„ì›”ì¼(7): ${escapeHtml(ag.to?.dob7||'')}</div>
            <div>ì£¼ì†Œ: ${escapeHtml(ag.to?.addr||'')}</div>
          </div>
        </div>

        <div style="margin-top:10px; border:1px solid #999; padding:8px;">
          <div style="font-weight:700; margin-bottom:6px;">í˜‘ì˜ ë‚´ìš©(ìš”ì§€)</div>
          <div style="white-space:pre-wrap; line-height:1.5;">${escapeHtml(ag.note||'')}</div>
        </div>

        <div style="margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:20px;">
          <div>
            <div style="font-size:12px; color:#555; margin-bottom:4px;">A ì„œëª…</div>
            ${ag.aSigDataUrl ? `<img src="${ag.aSigDataUrl}" style="height:80px; border:1px solid #ccc;"/>` : '<div style="height:80px;border:1px dashed #ccc;"></div>'}
          </div>
          <div>
            <div style="font-size:12px; color:#555; margin-bottom:4px;">B ì„œëª…</div>
            ${ag.bSigDataUrl ? `<img src="${ag.bSigDataUrl}" style="height:80px; border:1px solid #ccc;"/>` : '<div style="height:80px;border:1px dashed #ccc;"></div>'}
          </div>
        </div>

        <div style="margin-top:12px; font-size:11px; color:#666;">
          â€» ë³¸ ë¬¸ì„œëŠ” ë‚´ë¶€ í˜‘ì˜ ê¸°ë¡ìš©ì…ë‹ˆë‹¤. ë²•ì  ì „ìì„œëª… íš¨ë ¥ì€ ë³„ë„ ì‹œìŠ¤í…œì— ë”°ë¦…ë‹ˆë‹¤.
        </div>
      </div>`;
    document.body.appendChild(mount);

    const canvas = await html2canvas(mount, { scale: 2, backgroundColor:'#ffffff' });
    mount.remove();

    const imgData = canvas.toDataURL('image/png');
    const pdf = new window.jspdf.jsPDF({ unit:'mm', format:'a4' });
    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();
    const imgW = pageW - 20; // margin
    const imgH = canvas.height * imgW / canvas.width;
    pdf.addImage(imgData, 'PNG', 10, 10, imgW, imgH);
    return pdf.output('blob');
  }

  /* ---------- ìœ í‹¸ ---------- */
  function escapeHtml(s){ return String(s??'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

  function fmtDate(){ const d=new Date(); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}`; }
  function downloadBlob(blob, filename){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),2000); }
  function sanitizeFile(s){ return s.replace(/[^\w\-ê°€-í£]/g,'_').slice(0,60); }
  </script>
</body>
</html>
