<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>재조사_경계협의서_version1.0</title>
  <style>
    :root{ --bg:#0b1020; --card:#111834; --muted:#8fa3c1; --text:#e8eefb; --brand:#5aa0ff; --accent:#46e0b7; --danger:#ff6b6b; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0a0f1e 0%,#0b1226 100%);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:rgba(10,15,30,.7);border-bottom:1px solid rgba(255,255,255,.06)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:8px 0 12px;font-size:20px;letter-spacing:.2px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .btn{border:1px solid rgba(255,255,255,.1);background:#141b36;color:var(--text);padding:10px 14px;border-radius:12px;font-size:14px;cursor:pointer}
    .btn:hover{border-color:rgba(255,255,255,.2)}
    .btn.brand{background:linear-gradient(180deg,#579bff,#4f8fff);border:none;color:white}
    .btn.accent{background:linear-gradient(180deg,#49e6bb,#35cfa6);border:none;color:#0b1020}
    .btn.danger{background:#331a1a;border:1px solid #582727;color:#ffb3b3}
    .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,.25)}
    .grid{display:grid;gap:14px}
    .card{background:linear-gradient(180deg,#0f1734 0%,#0d142c 100%);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f1734;color:var(--text);font-size:14px}
    input[type="file"]{padding:8px;background:transparent;border:1px dashed rgba(255,255,255,.25)}
    table{width:100%;border-collapse:separate;border-spacing:0 8px; table-layout:fixed}
    col.pnu{width:120px} col.owner{width:120px} col.lot{width:140px} col.note{width:auto} col.sign{width:120px} col.ops{width:300px}
    thead th{font-size:12px;color:var(--muted);text-align:left;padding:4px 8px}
    tbody td{background:#0f1734;padding:10px 8px;border-top:1px solid rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.06);
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    tbody tr{transition:transform .12s ease}
    tbody tr:hover{transform:translateY(-1px)}
    tbody td:first-child{border-left:1px solid rgba(255,255,255,.06);border-top-left-radius:12px;border-bottom-left-radius:12px}
    tbody td:last-child{border-right:1px solid rgba(255,255,255,.06);border-top-right-radius:12px;border-bottom-right-radius:12px}
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 10px;font-size:12px;border:1px solid rgba(255,255,255,.12)}
    .pill.ok{background:rgba(70,224,183,.12);color:#8af0d8;border-color:rgba(70,224,183,.3)}
    .pill.no{background:rgba(255,107,107,.1);color:#ffc1c1;border-color:rgba(255,255,255,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    .right{margin-left:auto}
    .muted{color:var(--muted)}
    .sr{position:absolute;left:-9999px}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:40;padding:10px}
    .modal.open{display:flex}
    .modal .sheet{background:#0f1734;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;max-width:95vw;width:720px}
    .help{font-size:13px;color:var(--muted)} .small{font-size:12px}
    .tabs{display:flex;gap:6px;margin:8px 0} .tabs .btn{padding:6px 10px}
    canvas{width:100%;height:260px;background:white;border-radius:12px;touch-action:none}
    footer{padding:40px 16px;color:#8fa3c1;text-align:center}
    @media (max-width:820px){ .hide-m{display:none} header .toolbar{gap:6px} .btn{padding:8px 10px}
      col.pnu{width:110px} col.owner{width:110px} col.lot{width:130px} }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>📑 재조사_경계협의서 <span class="muted">· version1.0 </span></h1>
      <div class="toolbar">
        <label class="muted">작업방</label>
        <select id="wsSelect" title="작업방(사업지구) 선택"></select>
        <button id="btnAddWs" class="btn">+ 작업방</button>
        <button id="btnRenameWs" class="btn">이름변경</button>
        <button id="btnDelWs" class="btn danger">삭제</button>
        <button id="btnLockWs" class="btn danger">작업방 잠금</button>

        <span class="right"></span>

        <input id="q" placeholder="PNU / 소유자 / 지번 검색" style="max-width:280px">
        <button id="sortOwnerAsc" class="btn">소유자 ▲</button>
        <button id="sortOwnerDesc" class="btn">소유자 ▼</button>

        <label class="btn ghost" for="excelFile">📥 엑셀 불러오기</label>
        <input id="excelFile" class="sr" type="file" accept=".xlsx,.xls" />
        <button id="btnTemplate" class="btn">📄 템플릿</button>
        <button id="btnExportXlsx" class="btn">📤 엑셀로(이미지 포함)</button>
        <button id="btnExportJson" class="btn">🧰 백업(JSON)</button>
        <button id="btnImportJson" class="btn">🧰 복원(JSON)</button>
        <input id="jsonFile" class="sr" type="file" accept="application/json" />
        <button id="btnReset" class="btn danger">DB 초기화</button>
      </div>
    </div>
  </header>

  <main class="wrap grid" style="margin-top:8px">
    <section class="card" id="howto">
      <div class="row">
        <div>
          <strong>목적</strong>
          <div class="help">작업방 단위로 PNU별 소유자·지번·협의내용·전자서명(PNG 업로드/직접)을 관리합니다. 오프라인(IndexedDB)과 온라인(Firestore)이 자동 동기화됩니다.</div>
        </div>
        <div class="right help hide-m">저장 위치: 로컬 IndexedDB + Firestore(동기화). 공동사용/실시간 가능.</div>
      </div>
    </section>

    <section class="card" id="importer">
      <div class="row">
        <div>
          <label for="excelFile"><strong>1) 엑셀(.xlsx) 선택</strong></label>
          <div class="help">헤더: PNU, 소유자, 지번, 협의내용 권장(매핑 제공). 현재 작업방에 반영됩니다.</div>
        </div>
      </div>
      <div id="mapBox" style="display:none;margin-top:12px">
        <div class="row">
          <div><label>엑셀 헤더 → PNU</label><select id="mapPnu"></select></div>
          <div><label>엑셀 헤더 → 소유자</label><select id="mapOwner"></select></div>
          <div><label>엑셀 헤더 → 지번</label><select id="mapLot"></select></div>
          <div><label>엑셀 헤더 → 협의내용</label><select id="mapNote"></select></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnApplyMap" class="btn brand">매핑 적용 & 저장</button>
          <div class="help">동일 PNU는 업데이트됩니다(작업방 내).</div>
        </div>
      </div>
    </section>

    <section class="card" id="editor">
      <div class="help">※ 이 버전은 <strong>협의내용만 수정</strong>합니다(PNU/소유자/지번 변경은 재업로드 또는 삭제 후 등록).</div>
      <div style="overflow:auto">
        <table>
          <colgroup>
            <col class="pnu"><col class="owner"><col class="lot"><col class="note"><col class="sign"><col class="ops">
          </colgroup>
          <thead>
            <tr>
              <th>PNU</th>
              <th>소유자</th>
              <th>지번</th>
              <th>협의 내용</th>
              <th class="hide-m">서명</th>
              <th>작업</th>
            </tr>
          </thead>
            <tbody id="rows"></tbody>
        </table>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnNew" class="btn accent">+ 신규</button>
      </div>
    </section>

    <section class="card" id="cloudInfo">
      <strong>여러 명이 함께 쓰기(실시간)</strong>
      <div class="help">같은 작업방에 접속하면 내용이 실시간으로 동기화됩니다.</div>
    </section>
  </main>

  <footer>
    <div class="small">※ 서명 이미지는 로컬 DB 및 Firestore에 Data URL(Base64)로 저장됩니다. 법적 전자서명은 별도 시스템 연동 필요.</div>
  </footer>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <!-- 1) Dexie(IndexedDB) -->
  <script>
  const db = new Dexie('pnu_agreements');
  db.version(1).stores({ records:'pnu', signatures:'pnu' });
  db.version(2).stores({
    workspaces:'name',
    records:'[ws+pnu], ws, pnu',
    signatures:'[ws+pnu], ws, pnu'
  }).upgrade(async tx=>{
    const oldRecs = await tx.table('records').toArray().catch(()=>[]);
    const oldSigs = await tx.table('signatures').toArray().catch(()=>[]);
    if(oldRecs.length || oldSigs.length){
      await tx.table('workspaces').put({ name: '기본' });
      for(const r of oldRecs){ await tx.table('records').put({ ws:'기본', pnu:r.pnu, owner:r.owner, lot:r.lot, note:r.note }); }
      for(const s of oldSigs){ await tx.table('signatures').put({ ws:'기본', pnu:s.pnu, dataUrl:s.dataUrl, signedAt:s.signedAt }); }
    }else{
      await tx.table('workspaces').put({ name: '기본' });
    }
  });
  db.version(3).stores({
    workspaces:'name',
    records:'[ws+pnu], ws, pnu, updatedAtMs',
    signatures:'[ws+pnu], ws, pnu, updatedAtMs'
  }).upgrade(async tx=>{
    const now = Date.now();
    const recs = await tx.table('records').toArray().catch(()=>[]);
    for (const r of recs) { if (typeof r.updatedAtMs !== 'number') { r.updatedAtMs = now; await tx.table('records').put(r); } }
    const sigs = await tx.table('signatures').toArray().catch(()=>[]);
    for (const s of sigs) { if (typeof s.updatedAtMs !== 'number') { s.updatedAtMs = now; await tx.table('signatures').put(s); } }
  });
  window.db = db;
  </script>

  <!-- 2) Firebase 초기화 (CDN 모듈, 익명 로그인 + 멤버 자동생성) -->
<script type="module" id="firebase-init">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { initializeFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  // 🔧 프로젝트 문서 ID (규칙과 맞춤) — 원하면 바꾸세요
  const PROJECT_ID = 'default';
  window.__PROJECT_ID = PROJECT_ID;

  const firebaseConfig = {
    apiKey: "AIzaSyDh8dyrAbshk0npKTxZAdaX3_426txbRpI",
    authDomain: "jajosa-8d811.firebaseapp.com",
    projectId: "jajosa-8d811",
    storageBucket: "jajosa-8d811.firebasestorage.app",
    messagingSenderId: "616881022512",
    appId: "1:616881022512:web:cf3b8c32f4535bb65a6ff5",
    measurementId: "G-9J5C7KHCZG"
  };

  const app = initializeApp(firebaseConfig);

  // ⚙️ WebChannel 차단 환경 대응
  const fdb = initializeFirestore(app, {
    experimentalAutoDetectLongPolling: true,
    useFetchStreams: false
  });
  window.__fdb = fdb;

  // ✅ 익명 로그인 + 멤버 자동 생성(테스트: admin 부여)
  const auth = getAuth(app);
  window.__authReady = new Promise((resolve, reject) => {
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          const mref = doc(fdb, `projects/${PROJECT_ID}/members/${user.uid}`);
          const snap = await getDoc(mref);
          if (!snap.exists()) {
            await setDoc(mref, { role: 'admin', createdAt: new Date().toISOString() });
          }
        } catch(e) {
          console.warn('[members bootstrap] 실패:', e);
        }
      }
      resolve();
    }, reject);
  });
  signInAnonymously(auth).catch((e)=>console.warn('[auth] signInAnonymously 실패', e));
</script>

  <!-- 3) 동기화 헬퍼(IndexedDB ↔ Firestore) -->
  <script type="module">
  import {
    doc, setDoc, collection, query, where, onSnapshot, deleteDoc, getDocs,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const fdb = window.__fdb;
  const db  = window.db;
  const PROJECT_ID = window.__PROJECT_ID || 'default';

  // 문서ID 안전화(슬래시 등 제거)
  const safeId = (s)=> String(s ?? '').replaceAll('/', '_');

  // 규칙 경로에 맞춘 ref 헬퍼
  const pnuCol  = () => collection(fdb, `projects/${PROJECT_ID}/pnu`);
  const signCol = () => collection(fdb, `projects/${PROJECT_ID}/signatures`);
  const pnuDocRef  = (ws, pnu) => doc(fdb, `projects/${PROJECT_ID}/pnu/${safeId(ws)}__${safeId(pnu)}`);
  const signDocRef = (ws, pnu) => doc(fdb, `projects/${PROJECT_ID}/signatures/${safeId(ws)}__${safeId(pnu)}`);

  let applyingRemote = false;

  // ▶ 레코드 업서트: 로컬 저장 후, 규칙 스키마(pnu/owner/address/content/updatedAt)로 푸시
  async function upsertRecordLocalFirst(rec){
    const now = Date.now();
    const local = { ...rec, updatedAtMs: now };
    await db.records.put(local);

    if (applyingRemote) return;

    // ※ 규칙에서 pnu는 string 으로 변경 권장 (pnu is string)
    const remote = {
      pnu: String(rec.pnu),
      owner: rec.owner || '',
      address: rec.lot || '',
      content: rec.note || '',
      updatedAt: serverTimestamp()
    };

    try {
      await setDoc(pnuDocRef(rec.ws, rec.pnu), remote, { merge:true });
    } catch (e) {
      console.warn('[pnu.setDoc] 실패', e);
    }
  }

  // ▶ 서명 업서트: 로컬 저장 후, 규칙 스키마(signatureUrl/updatedAt + userId)로 푸시
  async function upsertSignatureLocalFirst(ws, pnu, dataUrl, signedAtISO=null){
    const now = Date.now();
    await db.signatures.put({ ws, pnu, dataUrl, signedAt: signedAtISO || new Date().toISOString(), updatedAtMs: now });

    if (applyingRemote) return;

    // userId는 규칙에서 create 시 본인만 허용에 필요
    const { getAuth } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js");
    const uid = getAuth().currentUser?.uid || 'unknown';
    const remote = {
      userId: uid,
      ws, pnu,
      signatureUrl: dataUrl,
      updatedAt: serverTimestamp()
    };

    try {
      await setDoc(signDocRef(ws, pnu), remote, { merge:true });
    } catch (e) {
      console.warn('[sign.setDoc] 실패', e);
    }
  }

  // ▶ 삭제
  async function deleteRecordAndSignatureLocalFirst(ws, pnu){
    await db.transaction('rw', db.records, db.signatures, async ()=>{
      await db.records.delete([ws,pnu]);
      await db.signatures.delete([ws,pnu]);
    });
    if (applyingRemote) return;
    try { await deleteDoc(pnuDocRef(ws, pnu)); }  catch(e){ console.warn('[pnu.delete] 실패', e); }
    try { await deleteDoc(signDocRef(ws, pnu)); } catch(e){ console.warn('[sign.delete] 실패', e); }
  }

  // ▶ 실시간 수신(규칙 경로)
  let unsubRecords=null, unsubSignatures=null;
  function stopCloudWatch(){ unsubRecords?.(); unsubRecords=null; unsubSignatures?.(); unsubSignatures=null; }

  function startCloudWatch(wsName){
    stopCloudWatch();

    // records → 로컬 반영
    unsubRecords = onSnapshot(
      // 필요시 where('ws','==',wsName)로 좁힐 수도 있음. (지금은 프로젝트 전체 수신)
      query(pnuCol()),
      async snap=>{
        applyingRemote = true;
        try{
          for(const ch of snap.docChanges()){
            const data = ch.doc.data();
            // 규칙 스키마 → 로컬 스키마 매핑
            const r = {
              ws: wsName,                         // 프로젝트 단위 컬렉션이므로 wsName 기준으로 필터링할 수도 있음
              pnu: String(data.pnu || ''),
              owner: data.owner || '',
              lot: data.address || '',
              note: data.content || '',
              updatedAtMs: Date.now()
            };
            if (!r.pnu) continue;
            // 현재 작업방에 해당하는 문서만 반영하고 싶으면 조건 추가:
            // if (!ch.doc.id.startsWith(safeId(wsName)+'__')) continue;
            await db.records.put(r);
          }
        } finally {
          applyingRemote = false;
          window.refreshList?.();
        }
      }
    );

    // signatures → 로컬 반영
    unsubSignatures = onSnapshot(
      query(signCol()),
      async snap=>{
        applyingRemote = true;
        try{
          for(const ch of snap.docChanges()){
            const d = ch.doc.data();
            const key = ch.doc.id.split('__')[1] || ''; // id = ws__pnu
            if (!key) continue;
            // 현재 작업방만 반영하려면 아래 조건 추가:
            // if (!ch.doc.id.startsWith(safeId(wsName)+'__')) continue;
            await db.signatures.put({
              ws: wsName,
              pnu: key,
              dataUrl: d.signatureUrl || '',
              signedAt: d.updatedAt?.toDate?.()?.toISOString?.() || new Date().toISOString(),
              updatedAtMs: Date.now()
            });
          }
        } finally {
          applyingRemote = false;
          window.refreshList?.();
        }
      }
    );
  }

  window.SyncAPI = {
    upsertRecordLocalFirst,
    upsertSignatureLocalFirst,
    deleteRecordAndSignatureLocalFirst,
    startCloudWatch,
    stopCloudWatch
  };
</script>

  <!-- 4) 앱 로직(UI/CRUD/서명/엑셀) -->
  <script>
  // (옵션) 일부 구형 브라우저용 ResizeObserver 폴백
  window.ResizeObserver = window.ResizeObserver || class { constructor(){ } observe(){ } unobserve(){ } disconnect(){ } };

  const $ = s=>document.querySelector(s);
  const wsSelect=$('#wsSelect');
  const fileInput=$('#excelFile');
  const mapBox=$('#mapBox'); const mapPnu=$('#mapPnu'); const mapOwner=$('#mapOwner'); const mapLot=$('#mapLot'); const mapNote=$('#mapNote'); const btnApplyMap=$('#btnApplyMap');
  const rowsEl=$('#rows'); const qEl=$('#q'); const sortOwnerAscBtn=$('#sortOwnerAsc'); const sortOwnerDescBtn=$('#sortOwnerDesc');

  let excelHeaders=[], excelRows=[], currentQuery='', sortMode='pnu';
  let currentWS=localStorage.getItem('pnu_current_ws')||'기본', lastWS=currentWS;

  // ✅ 작업방 접근 암호
  const WS_PASS="lx전북재조사추진단";
  function wsKey(ws){ return `ws_authed_${ws}`; }
  async function ensureWorkspaceAuth(ws){
    if(sessionStorage.getItem(wsKey(ws))==='ok') return true;
    const input=prompt(`작업방 "${ws}" 접근 암호를 입력하세요.`);
    if(input===null) return false;
    if(input===WS_PASS){ sessionStorage.setItem(wsKey(ws),'ok'); return true; }
    alert('암호를 확인해주세요.'); return false;
  }

  // ✅ SyncAPI 로딩 대기 유틸
  function whenSyncReady(timeoutMs = 10000) {
    return new Promise((resolve, reject) => {
      if (window.SyncAPI) return resolve();
      const start = Date.now();
      const iv = setInterval(() => {
        if (window.SyncAPI) { clearInterval(iv); resolve(); }
        else if (Date.now() - start > timeoutMs) {
          clearInterval(iv);
          reject(new Error('SyncAPI load timeout'));
        }
      }, 50);
    });
  }

  async function refreshWorkspaces(){
    let list = await db.workspaces.toArray();
    if(!list.find(w=>w.name===currentWS)){
      if(list.length===0){ await db.workspaces.put({name:'기본'}); list = await db.workspaces.toArray(); }
      currentWS=list[0]?.name||'기본'; localStorage.setItem('pnu_current_ws', currentWS);
    }
    wsSelect.innerHTML = list.map(w=>`<option ${w.name===currentWS?'selected':''} value="${escapeHtml(w.name)}">${escapeHtml(w.name)}</option>`).join('');
  }

  wsSelect.addEventListener('change', async (e)=>{
    const targetWS=e.target.value;
    const ok=await ensureWorkspaceAuth(targetWS);
    if(!ok){ wsSelect.value=lastWS; return; }
    lastWS=targetWS; currentWS=targetWS; localStorage.setItem('pnu_current_ws', currentWS);
    await whenSyncReady();                   // ✅ SyncAPI 준비 대기
    window.SyncAPI.startCloudWatch(currentWS);
    refreshList();
  });

  // 초기 가드 + 워치 시작
  (async function guardInit(){
    try {
      await whenSyncReady();                 // ✅ SyncAPI 준비 대기
      await refreshWorkspaces();
      const ok = await ensureWorkspaceAuth(currentWS);
      if(!ok) return;
      lastWS = currentWS;
      window.SyncAPI.startCloudWatch(currentWS);
      refreshList();
    } catch (e) {
      console.error('[init] SyncAPI not ready:', e);
      alert('초기화 중 문제가 발생했습니다. 콘솔을 확인해 주세요.');
    }
  })();

  $('#btnAddWs').addEventListener('click', async ()=>{
    const name=prompt('새 작업방 이름'); if(!name) return;
    const n=name.trim(); if(!n) return;
    if(await db.workspaces.get(n)){ alert('같은 이름이 있습니다.'); return; }
    await db.workspaces.put({name:n}); await refreshWorkspaces();
    const ok=await ensureWorkspaceAuth(n); if(!ok) return;
    currentWS=n; lastWS=n; localStorage.setItem('pnu_current_ws', currentWS);
    await refreshWorkspaces();
    await whenSyncReady();
    window.SyncAPI.startCloudWatch(currentWS);
    await refreshList();
  });

  $('#btnRenameWs').addEventListener('click', async ()=>{
    const old=currentWS; const neo=prompt(`작업방 이름 변경: ${old} →`, old);
    if(neo===null) return; const n=neo.trim(); if(!n||n===old) return;
    if(await db.workspaces.get(n)){ alert('이미 존재하는 이름입니다.'); return; }
    await db.transaction('rw', db.workspaces, db.records, db.signatures, async ()=>{
      await db.workspaces.delete(old); await db.workspaces.put({name:n});
      const recs=await db.records.where('ws').equals(old).toArray();
      for(const r of recs){ await db.records.delete([old,r.pnu]); await db.records.put({...r, ws:n}); }
      const sigs=await db.signatures.where('ws').equals(old).toArray();
      for(const s of sigs){ await db.signatures.delete([old,s.pnu]); await db.signatures.put({...s, ws:n}); }
    });
    const ok=await ensureWorkspaceAuth(n); if(!ok) return;
    currentWS=n; lastWS=n; localStorage.setItem('pnu_current_ws', currentWS);
    await refreshWorkspaces();
    await whenSyncReady();
    window.SyncAPI.startCloudWatch(currentWS);
    await refreshList();
  });

  $('#btnDelWs').addEventListener('click', async ()=>{
    const name=currentWS; const list=await db.workspaces.toArray();
    if(list.length<=1){ alert('최소 1개 작업방 필요'); return; }
    if(!confirm(`"${name}" 삭제? (복구 불가)`)) return;
    await db.transaction('rw', db.workspaces, db.records, db.signatures, async ()=>{
      await db.workspaces.delete(name);
      const recs=await db.records.where('ws').equals(name).toArray();
      for(const r of recs){ await db.records.delete([name,r.pnu]); }
      const sigs=await db.signatures.where('ws').equals(name).toArray();
      for(const s of sigs){ await db.signatures.delete([name,s.pnu]); }
    });
    const remain=await db.workspaces.toArray();
    currentWS=remain[0].name; lastWS=currentWS; localStorage.setItem('pnu_current_ws', currentWS);
    await refreshWorkspaces();
    await whenSyncReady();
    window.SyncAPI.startCloudWatch(currentWS);
    await refreshList();
  });

  $('#btnLockWs').addEventListener('click', ()=>{
    sessionStorage.removeItem(wsKey(currentWS));
    alert('이 작업방의 인증이 초기화되었습니다. 다시 접근 시 암호가 필요합니다.');
  });

  // 엑셀 업로드(매핑)
  fileInput.addEventListener('change', async e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const {headers,rows}=await parseExcel(f);
    excelHeaders=headers; excelRows=rows; buildMappingSelects(headers);
    mapBox.style.display='block';
  });
  function buildMappingSelects(headers){
    const fill=(sel, guess=[])=>{
      sel.innerHTML='<option value="">(사용 안함)</option>'+headers.map((h,i)=>`<option value="${i}">${escapeHtml(h)}</option>`).join('');
      for(const g of guess){ const idx=headers.findIndex(h=>h.toLowerCase().includes(g)); if(idx>=0){ sel.value=String(idx); break; } }
    };
    fill(mapPnu,   ['pnu','필지','고유','parcel']);
    fill(mapOwner, ['소유','owner','성명','이름','대표']);
    fill(mapLot,   ['지번','주소','lot','parcel','address']);
    fill(mapNote,  ['협의','내용','비고','note','memo']);
  }
  $('#btnApplyMap').addEventListener('click', async ()=>{
    if(!excelRows.length){ alert('엑셀을 먼저 불러오세요.'); return; }
    const idx={ pnu:parseInt(mapPnu.value,10), owner:parseInt(mapOwner.value,10), lot:parseInt(mapLot.value,10), note:parseInt(mapNote.value,10) };
    if(Number.isNaN(idx.pnu)) { alert('PNU 매핑은 필수'); return; }
    let upserted=0;
    await db.transaction('rw', db.records, async ()=>{
      for(const row of excelRows){
        const rec={ ws:currentWS, pnu:normalizePnu(cell(row,idx.pnu)), owner:cell(row,idx.owner), lot:cell(row,idx.lot), note:cell(row,idx.note) };
        if(!rec.pnu) continue;
        await db.records.put({ ...rec, updatedAtMs: Date.now() });
        upserted++;
      }
    });

  const allJustSaved = await db.records.where('ws').equals(currentWS).toArray();
  allJustSaved.forEach(r=>{
    window.SyncAPI?.upsertRecordLocalFirst(r);
  });

    alert(`(${currentWS}) ${upserted.toLocaleString()}건 저장/갱신`);
    mapBox.style.display='none'; fileInput.value=''; refreshList();
  });
  async function parseExcel(file){
    const data=await file.arrayBuffer();
    const wb=XLSX.read(data,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{header:1, defval:''});
    const headers=rows.shift()?.map(String)??[];
    return {headers, rows};
  }
  function cell(row, idx){ if(Number.isNaN(idx)) return ''; return (row?.[idx]??'').toString().trim(); }
  function normalizePnu(v){ if(!v) return ''; return String(v).replace(/\s+/g,'').replace(/[^0-9-]/g,''); }

  qEl.addEventListener('input', e=>{ currentQuery=e.target.value; refreshList(); });
  sortOwnerAscBtn.addEventListener('click', ()=>{ sortMode='ownerAsc'; refreshList(); });
  sortOwnerDescBtn.addEventListener('click', ()=>{ sortMode='ownerDesc'; refreshList(); });

  async function refreshList(){
    const all=await db.records.where('ws').equals(currentWS).toArray();
    const sigs=await db.signatures.where('ws').equals(currentWS).toArray();
    const sigMap=new Map(sigs.map(s=>[s.pnu,s]));

    const q=currentQuery.trim().toLowerCase();
    let filtered = q
      ? all.filter(r => r.pnu.toLowerCase().includes(q) || (r.owner||'').toLowerCase().includes(q) || (r.lot||'').toLowerCase().includes(q))
      : all;

    if(sortMode==='ownerAsc') filtered.sort((a,b)=>(a.owner||'').localeCompare(b.owner||'','ko'));
    else if(sortMode==='ownerDesc') filtered.sort((a,b)=>(b.owner||'').localeCompare(a.owner||'','ko'));
    else filtered.sort((a,b)=>a.pnu.localeCompare(b.pnu));

    rowsEl.innerHTML = filtered.map(r=>{
      const s=sigMap.get(r.pnu); const signed=!!s?.dataUrl;
      const when=s?.signedAt?new Date(s.signedAt).toLocaleString():'';
      const pnuEnc=encodeURIComponent(r.pnu);
      return `<tr>
        <td title="${escapeHtml(r.pnu)}"><span class="small muted">#</span> ${escapeHtml(r.pnu)}</td>
        <td title="${escapeHtml(r.owner||'')}">${escapeHtml(r.owner||'')}</td>
        <td title="${escapeHtml(r.lot||'')}">${escapeHtml(r.lot||'')}</td>
        <td title="${escapeHtml((r.note||'').replace(/\n/g,' '))}">${escapeHtml(r.note||'')}</td>
        <td class="hide-m">${signed?`<span class="pill ok">서명</span><div class="small muted">${escapeHtml(when)}</div>`:`<span class="pill no">미서명</span>`}</td>
        <td>
          <div class="row" style="gap:6px">
            <button class="btn btn-edit" data-pnu="${pnuEnc}">✏️ 협의내용</button>
            <button class="btn accent btn-sign" data-pnu="${pnuEnc}">✍️ 서명(업로드/직접)</button>
            <button class="btn btn-preview" data-pnu="${pnuEnc}">🖼️ 서명보기</button>
            <button class="btn danger btn-del" data-pnu="${pnuEnc}">🗑️ 삭제</button>
          </div>
        </td>
      </tr>`;
    }).join('');
  }
  window.refreshList = refreshList;

  // 신규 추가
  $('#btnNew').addEventListener('click', async ()=>{
    const pnu=prompt(`[${currentWS}] 신규 PNU(고유키)`); if(pnu===null) return;
    const key=normalizePnu(pnu); if(!key){ alert('PNU는 필수'); return; }
    const owner=prompt('소유자:')??''; const lot=prompt('지번:')??'';
    await window.SyncAPI.upsertRecordLocalFirst({ws:currentWS, pnu:key, owner:owner.trim(), lot:lot.trim(), note:''});
    openNoteModal(key,'');
  });

  // 행 버튼들
  rowsEl.addEventListener('click', async e=>{
    const btn=e.target.closest('button'); if(!btn) return;
    const pnu=decodeURIComponent(btn.dataset.pnu||''); if(!pnu) return;

    if(btn.classList.contains('btn-edit')){
      const rec=await db.records.get([currentWS,pnu]);
      if(!rec){ alert('레코드를 찾을 수 없습니다.'); return; }
      openNoteModal(pnu, rec.note||'');
    }else if(btn.classList.contains('btn-sign')){
      openSignModal(pnu);
    }else if(btn.classList.contains('btn-preview')){
      const s=await db.signatures.get([currentWS,pnu]);
      if(!s?.dataUrl){ alert('서명이 없습니다.'); return; }
      const win=window.open(); win.document.write(`<img alt="signature" src="${s.dataUrl}">`);
    }else if(btn.classList.contains('btn-del')){
      if(!confirm(`삭제할까요?\n[${currentWS}] PNU: ${pnu}`)) return;
      await window.SyncAPI.deleteRecordAndSignatureLocalFirst(currentWS, pnu);
      refreshList();
    }
  });

  // 협의내용 모달
  let noteModal, noteTextarea, noteSaveBtn, noteCloseBtn, notePnuLabel, notePnu='';
  function ensureNoteModal(){
    if(noteModal) return;
    noteModal=document.createElement('div'); noteModal.className='modal';
    noteModal.innerHTML=`
      <div class="sheet">
        <div class="row" style="align-items:center">
          <h3 style="margin:0">협의 내용</h3><span class="right"></span>
          <button class="btn" id="btnCloseNote">닫기</button>
        </div>
        <div class="help" id="noteTarget" style="margin:6px 0 10px"></div>
        <textarea id="noteTextarea" rows="10" placeholder="협의 내용을 입력하세요(줄바꿈 가능)"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn brand" id="btnSaveNote">저장</button>
        </div>
      </div>`;
    document.body.appendChild(noteModal);
    noteTextarea=noteModal.querySelector('#noteTextarea');
    noteSaveBtn=noteModal.querySelector('#btnSaveNote');
    noteCloseBtn=noteModal.querySelector('#btnCloseNote');
    notePnuLabel=noteModal.querySelector('#noteTarget');

    noteCloseBtn.addEventListener('click', ()=> noteModal.classList.remove('open'));
    noteSaveBtn.addEventListener('click', async ()=>{
      const rec=await db.records.get([currentWS, notePnu]);
      if(!rec){ alert('레코드를 찾을 수 없습니다.'); return; }
      await window.SyncAPI.upsertRecordLocalFirst({ ...rec, note: (noteTextarea.value||'').trim() });
      noteModal.classList.remove('open'); refreshList();
    });
  }
  function openNoteModal(pnu, note){
    ensureNoteModal(); notePnu=pnu;
    notePnuLabel.textContent=`[${currentWS}] PNU ${pnu}`;
    noteTextarea.value=note||''; noteModal.classList.add('open'); noteTextarea.focus();
  }

  // 서명 모달
  let sigModal, tabUploadBtn, tabDrawBtn, upFile, upPreview, drawCanvas, drawPad, clearDrawBtn, saveSigBtn, closeSigBtn, sigPnuLabel, sigPnu='';
  function ensureSignModal(){
    if(sigModal) return;
    sigModal=document.createElement('div'); sigModal.className='modal';
    sigModal.innerHTML=`
      <div class="sheet">
        <div class="row" style="align-items:center">
          <h3 style="margin:0">서명 (PNG 업로드 또는 직접 서명)</h3><span class="right"></span>
          <button class="btn" id="btnCloseSig">닫기</button>
        </div>
        <div class="help" id="sigTarget" style="margin:6px 0 10px"></div>
        <div class="tabs"><button class="btn" id="tabUpload">PNG 업로드</button><button class="btn" id="tabDraw">직접 서명</button></div>
        <div id="paneUpload">
          <input id="upFile" type="file" accept="image/png">
          <div style="margin-top:10px"><img id="upPreview" alt="미리보기" style="max-width:100%;border-radius:8px;display:none"></div>
        </div>
        <div id="paneDraw" style="display:none; margin-top:8px">
          <canvas id="drawCanvas"></canvas>
          <div class="row" style="margin-top:8px"><button class="btn" id="btnClearDraw">지우기</button></div>
          <div class="help">터치/펜/마우스로 서명하세요.</div>
        </div>
        <div class="row" style="margin-top:12px"><button class="btn brand" id="btnSaveSig">저장</button></div>
      </div>`;
    document.body.appendChild(sigModal);
    tabUploadBtn = sigModal.querySelector('#tabUpload'); tabDrawBtn   = sigModal.querySelector('#tabDraw');
    upFile       = sigModal.querySelector('#upFile');    upPreview    = sigModal.querySelector('#upPreview');
    drawCanvas   = sigModal.querySelector('#drawCanvas'); clearDrawBtn= sigModal.querySelector('#btnClearDraw');
    saveSigBtn   = sigModal.querySelector('#btnSaveSig'); closeSigBtn = sigModal.querySelector('#btnCloseSig');
    sigPnuLabel  = sigModal.querySelector('#sigTarget');

    tabUploadBtn.addEventListener('click', ()=>{ showPane('upload'); });
    tabDrawBtn.addEventListener('click',   ()=>{ showPane('draw'); resizeDrawCanvas(); drawPad?.clear(); });
    upFile.addEventListener('change', ()=>{
      const f=upFile.files?.[0];
      if(!f){ upPreview.style.display='none'; return; }
      if(f.type!=='image/png'){ alert('PNG 형식만 업로드 가능합니다.'); upFile.value=''; upPreview.style.display='none'; return; }
      const reader=new FileReader();
      reader.onload=ev=>{ upPreview.src=ev.target.result; upPreview.style.display='block'; };
      reader.readAsDataURL(f);
    });
    // ✅ UMD 전역 사용
    drawPad = new window.SignaturePad(drawCanvas, { backgroundColor:'white', penColor:'black' });
    clearDrawBtn.addEventListener('click', ()=> drawPad.clear());
    closeSigBtn.addEventListener('click', ()=> sigModal.classList.remove('open'));
    saveSigBtn.addEventListener('click', async ()=>{
      let dataUrl=''; const f=upFile.files?.[0];
      if(f){ if(f.type!=='image/png'){ alert('PNG 형식만 업로드 가능합니다.'); return; }
        dataUrl = upPreview.src || await fileToDataURL(f);
      }else{ if(drawPad.isEmpty()){ alert('서명이 비어 있습니다.'); return; }
        dataUrl = drawPad.toDataURL('image/png');
      }
      await window.SyncAPI.upsertSignatureLocalFirst(currentWS, sigPnu, dataUrl);
      sigModal.classList.remove('open'); upFile.value=''; upPreview.style.display='none'; drawPad.clear();
      refreshList();
    });
    const ro=new ResizeObserver(resizeDrawCanvas); ro.observe(drawCanvas);
    window.addEventListener('orientationchange', ()=> setTimeout(resizeDrawCanvas, 300));
  }
  function showPane(which){
    const upPane=sigModal.querySelector('#paneUpload');
    const drawPane=sigModal.querySelector('#paneDraw');
    if(which==='upload'){ upPane.style.display='block'; drawPane.style.display='none'; }
    else { upPane.style.display='none'; drawPane.style.display='block'; }
  }
  function resizeDrawCanvas(){
    const ratio=Math.max(window.devicePixelRatio||1,1);
    const rect=drawCanvas.getBoundingClientRect();
    drawCanvas.width=rect.width*ratio; drawCanvas.height=260*ratio; const ctx=drawCanvas.getContext('2d'); ctx.scale(ratio,ratio);
  }
  async function fileToDataURL(f){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.onerror=rej; r.readAsDataURL(f); }); }
  async function openSignModal(pnu){
    ensureSignModal(); sigPnu=pnu;
    const rec=await db.records.get([currentWS, pnu]); if(!rec){ alert('레코드가 없습니다.'); return; }
    sigPnuLabel.textContent=`[${currentWS}] PNU ${rec.pnu} · ${rec.owner||''} · ${rec.lot||''}`;
    showPane('upload'); upFile.value=''; upPreview.style.display='none'; drawPad.clear();
    sigModal.classList.add('open'); setTimeout(resizeDrawCanvas, 50);
  }

  // 엑셀 내보내기 (서명 이미지 삽입)
  $('#btnExportXlsx').addEventListener('click', async ()=>{
    const wb=new ExcelJS.Workbook();
    const ws=wb.addWorksheet(currentWS.slice(0,31));
    const headers=['작업방','PNU','소유자','지번','협의내용','서명여부','서명시각','서명이미지'];
    ws.addRow(headers); ws.getRow(1).font={bold:true};
    ws.columns=[ {key:'ws',width:12},{key:'pnu',width:20},{key:'owner',width:14},{key:'lot',width:18},{key:'note',width:60},{key:'signed',width:10},{key:'signedAt',width:20},{key:'sigImg',width:30} ];

    const recs=await db.records.where('ws').equals(currentWS).toArray();
    const sigMap=new Map((await db.signatures.where('ws').equals(currentWS).toArray()).map(s=>[s.pnu,s]));
    const imageWidth=180, imageHeight=60;

    for(const r of recs){
      const sig=sigMap.get(r.pnu);
      const row=ws.addRow({
        ws: currentWS,
        pnu: r.pnu, owner: r.owner||'', lot: r.lot||'',
        note: r.note||'',
        signed: sig?'Y':'N',
        signedAt: sig?.signedAt? new Date(sig.signedAt).toLocaleString(): '',
        sigImg: ''
      });
      row.alignment={vertical:'top', wrapText:true};
      if(sig?.dataUrl){
        const base64=sig.dataUrl.split(',')[1];
        const imageId=wb.addImage({ base64, extension:'png' });
        const rowNumber=row.number;
        ws.addImage(imageId, { tl:{ col:7, row:rowNumber-1 }, ext:{ width:imageWidth, height:imageHeight } });
        ws.getRow(rowNumber).height = Math.max(ws.getRow(rowNumber).height||0, 50);
      }
    }
    ws.eachRow((row,rn)=>{ row.eachCell(cell=>{ cell.border={ top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'},right:{style:'thin'} }; if(rn===1){ cell.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFEEF3FF'}}; } }); });
    const buf=await wb.xlsx.writeBuffer();
    saveAs(new Blob([buf],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}), `pnu_${sanitizeFile(currentWS)}_${fmtDate()}.xlsx`);
  });

  // JSON 백업/복원/템플릿/리셋
  $('#btnExportJson').addEventListener('click', async ()=>{
    const payload={ exportedAt:new Date().toISOString(), workspaces:await db.workspaces.toArray(), records:await db.records.toArray(), signatures:await db.signatures.toArray() };
    downloadBlob(new Blob([JSON.stringify(payload,null,2)], {type:'application/json'}), `pnu_backup_all_${fmtDate()}.json`);
  });
  $('#btnImportJson').addEventListener('click', ()=> $('#jsonFile').click());
  $('#jsonFile').addEventListener('change', async e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const data=JSON.parse(await f.text());
    if(!Array.isArray(data.records)||!Array.isArray(data.signatures)) { alert('백업 형식이 올바르지 않습니다.'); return; }
    await db.transaction('rw', db.workspaces, db.records, db.signatures, async ()=>{
      await db.workspaces.clear(); await db.records.clear(); await db.signatures.clear();
      const wsList=data.workspaces?.length?data.workspaces:[{name:'기본'}];
      for(const w of wsList) await db.workspaces.put({name:w.name});
      for(const r of data.records) await db.records.put(r);
      for(const s of data.signatures) await db.signatures.put(s);
    });
    await refreshWorkspaces(); alert('복원 완료'); refreshList();
  });
  $('#btnTemplate').addEventListener('click', ()=>{
    const wb=XLSX.utils.book_new();
    const rows=[{ PNU:'1111010100100000000', 소유자:'홍길동', 지번:'서울 종로구 1-1', 협의내용:'보상 협의 1차 완료' }];
    const ws=XLSX.utils.json_to_sheet(rows); XLSX.utils.book_append_sheet(wb, ws, '템플릿'); XLSX.writeFile(wb,'pnu_template.xlsx');
  });
  $('#btnReset').addEventListener('click', async ()=>{
    if(!confirm('DB 초기화? 모든 작업방의 레코드/서명이 삭제됩니다.')) return;
    await db.transaction('rw', db.workspaces, db.records, db.signatures, async ()=>{
      await db.workspaces.clear(); await db.records.clear(); await db.signatures.clear();
    });
    await db.workspaces.put({name:'기본'}); currentWS='기본'; lastWS='기본'; localStorage.setItem('pnu_current_ws', currentWS);
    await refreshWorkspaces();
    await whenSyncReady();
    window.SyncAPI.startCloudWatch(currentWS);
    refreshList();
  });

  function fmtDate(){ const d=new Date(); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}`; }
  function downloadBlob(blob, filename){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),2000); }
  function escapeHtml(s){ return String(s??'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
  function sanitizeFile(s){ return s.replace(/[^\w\-가-힣]/g,'_').slice(0,60); }
  </script>
</body>
</html>
