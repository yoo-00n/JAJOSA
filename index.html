<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PNU í˜‘ì˜Â·ì„œëª… ê´€ë¦¬ Â· ì‘ì—…ë°©(ì‚¬ì—…ì§€êµ¬)ë³„ í´ë” â€” ã„± ë²„ì „</title>
  <style>
    :root{
      --bg:#0b1020; --card:#111834; --muted:#8fa3c1; --text:#e8eefb; --brand:#5aa0ff; --accent:#46e0b7; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0a0f1e 0%,#0b1226 100%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
    header{position:sticky;top:0;z-index:10;backdrop-filter:blur(6px);background:rgba(10,15,30,.7);border-bottom:1px solid rgba(255,255,255,.06)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:8px 0 12px;font-size:20px;letter-spacing:.2px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .btn{border:1px solid rgba(255,255,255,.1);background:#141b36;color:var(--text);padding:10px 14px;border-radius:12px;font-size:14px;cursor:pointer}
    .btn:hover{border-color:rgba(255,255,255,.2)}
    .btn.brand{background:linear-gradient(180deg,#579bff,#4f8fff);border:none;color:white}
    .btn.accent{background:linear-gradient(180deg,#49e6bb,#35cfa6);border:none;color:#0b1020}
    .btn.danger{background:#331a1a;border:1px solid #582727;color:#ffb3b3}
    .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,.25)}
    .grid{display:grid;gap:14px}
    .card{background:linear-gradient(180deg,#0f1734 0%,#0d142c 100%);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f1734;color:var(--text);font-size:14px}
    input[type="file"]{padding:8px;background:transparent;border:1px dashed rgba(255,255,255,.25)}
    table{width:100%;border-collapse:separate;border-spacing:0 8px; table-layout:fixed}
    col.pnu{width:140px}
    col.owner{width:140px}
    col.lot{width:160px}
    col.note{width:auto}
    col.sign{width:120px}
    col.ops{width:260px}
    thead th{font-size:12px;color:var(--muted);text-align:left;padding:4px 8px}
    tbody td{background:#0f1734;padding:10px 8px;border-top:1px solid rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.06);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    tbody tr{transition:transform .12s ease}
    tbody tr:hover{transform:translateY(-1px)}
    tbody td:first-child{border-left:1px solid rgba(255,255,255,.06);border-top-left-radius:12px;border-bottom-left-radius:12px}
    tbody td:last-child{border-right:1px solid rgba(255,255,255,.06);border-top-right-radius:12px;border-bottom-right-radius:12px}
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 10px;font-size:12px;border:1px solid rgba(255,255,255,.12)}
    .pill.ok{background:rgba(70,224,183,.12);color:#8af0d8;border-color:rgba(70,224,183,.3)}
    .pill.no{background:rgba(255,107,107,.1);color:#ffc1c1;border-color:rgba(255,107,107,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    .right{margin-left:auto}
    .muted{color:var(--muted)}
    .sr{position:absolute;left:-9999px}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:40}
    .modal.open{display:flex}
    .modal .sheet{background:#0f1734;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;max-width:95vw;width:680px}
    .help{font-size:13px;color:var(--muted)}
    .small{font-size:12px}
    .tag{display:inline-block;background:#16224a;border:1px solid rgba(255,255,255,.1);padding:2px 8px;border-radius:8px;color:#b9c8e3;font-size:12px}
    .kbar{display:flex;gap:8px;align-items:center;margin:8px 0}
    .kbar input{flex:1}
    footer{padding:40px 16px;color:#8fa3c1;text-align:center}
    @media (max-width:820px){
      .hide-m{display:none}
      header .toolbar{gap:6px}
      .btn{padding:8px 10px}
      col.pnu{width:120px}
      col.owner{width:120px}
      col.lot{width:140px}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ğŸ“‘ PNU í˜‘ì˜Â·ì„œëª… ê´€ë¦¬ <span class="muted">Â· ì‘ì—…ë°©(ì‚¬ì—…ì§€êµ¬)ë³„</span> <span class="muted">â€” ã„± ë²„ì „</span></h1>
      <div class="toolbar">
        <!-- ì‘ì—…ë°© ì„ íƒ/ê´€ë¦¬ -->
        <label class="muted">ì‘ì—…ë°©</label>
        <select id="wsSelect" title="ì‘ì—…ë°©(ì‚¬ì—…ì§€êµ¬) ì„ íƒ"></select>
        <button id="btnAddWs" class="btn">+ ì‘ì—…ë°©</button>
        <button id="btnRenameWs" class="btn">ì´ë¦„ë³€ê²½</button>
        <button id="btnDelWs" class="btn danger">ì‚­ì œ</button>

        <span class="right"></span>

        <!-- ê²€ìƒ‰ & ì •ë ¬ -->
        <input id="q" placeholder="PNU / ì†Œìœ ì / ì§€ë²ˆ ê²€ìƒ‰" style="max-width:280px">
        <button id="sortOwnerAsc" class="btn">ì†Œìœ ì â–²</button>
        <button id="sortOwnerDesc" class="btn">ì†Œìœ ì â–¼</button>

        <!-- íŒŒì¼ ì…ì¶œë ¥ -->
        <label class="btn ghost" for="excelFile">ğŸ“¥ ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°</label>
        <input id="excelFile" class="sr" type="file" accept=".xlsx,.xls" />
        <button id="btnTemplate" class="btn">ğŸ“„ í…œí”Œë¦¿</button>
        <button id="btnExportXlsx" class="btn">ğŸ“¤ ì—‘ì…€ë¡œ</button>
        <button id="btnExportJson" class="btn">ğŸ§° ë°±ì—…(JSON)</button>
        <button id="btnImportJson" class="btn">ğŸ§° ë³µì›(JSON)</button>
        <input id="jsonFile" class="sr" type="file" accept="application/json" />
        <button id="btnReset" class="btn danger">DB ì´ˆê¸°í™”</button>
      </div>
    </div>
  </header>

  <main class="wrap grid" style="margin-top:8px">
    <section class="card" id="howto">
      <div class="row">
        <div>
          <strong>ëª©ì </strong>
          <div class="help">ì‘ì—…ë°©(ì‚¬ì—…ì§€êµ¬/í–‰ì •êµ¬ì—­) ë‹¨ìœ„ë¡œ <span class="tag">PNU</span>ë³„ <span class="tag">ì†Œìœ ì</span>Â·<span class="tag">ì§€ë²ˆ</span>Â·<span class="tag">í˜‘ì˜ë‚´ìš©</span>Â·<span class="tag">ì „ìì„œëª…(PNG ì—…ë¡œë“œ)</span>ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</div>
        </div>
        <div class="right help hide-m">ì €ì¥ ìœ„ì¹˜: ë¸Œë¼ìš°ì € ë¡œì»¬ DB(IndexedDB). ì—¬ëŸ¬ ëª… ê³µë™ ì‘ì—…ì€ ë°±ì—”ë“œ ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>
      </div>
    </section>

    <section class="card" id="importer">
      <div class="row">
        <div>
          <label for="excelFile"><strong>1) ì—‘ì…€(.xlsx) ì„ íƒ</strong></label>
          <div class="help">í•„ìˆ˜ í—¤ë” ê¶Œì¥: <code>PNU</code>, <code>ì†Œìœ ì</code>, <code>ì§€ë²ˆ</code>, <code>í˜‘ì˜ë‚´ìš©</code> (í—¤ë”ëª…ì´ ë‹¬ë¼ë„ ë§¤í•‘ ê°€ëŠ¥). ì—…ë¡œë“œëŠ” <strong>í˜„ì¬ ì‘ì—…ë°©</strong>ì— ë°˜ì˜ë©ë‹ˆë‹¤.</div>
        </div>
      </div>
      <div id="mapBox" style="display:none;margin-top:12px">
        <div class="row">
          <div><label>ì—‘ì…€ í—¤ë” â†’ PNU</label><select id="mapPnu"></select></div>
          <div><label>ì—‘ì…€ í—¤ë” â†’ ì†Œìœ ì</label><select id="mapOwner"></select></div>
          <div><label>ì—‘ì…€ í—¤ë” â†’ ì§€ë²ˆ</label><select id="mapLot"></select></div>
          <div><label>ì—‘ì…€ í—¤ë” â†’ í˜‘ì˜ë‚´ìš©</label><select id="mapNote"></select></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnApplyMap" class="btn brand">ë§¤í•‘ ì ìš© & ì €ì¥</button>
          <div class="help">ë™ì¼ PNUëŠ” ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤(ì‘ì—…ë°© ë‚´ì—ì„œë§Œ).</div>
        </div>
      </div>
    </section>

    <section class="card" id="editor">
      <div class="help">â€» ì´ ë²„ì „ì—ì„œëŠ” <strong>â€˜í˜‘ì˜ ë‚´ìš©â€™ë§Œ ìˆ˜ì •</strong>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. PNU/ì†Œìœ ì/ì§€ë²ˆ ë³€ê²½ì€ ì—‘ì…€ ì¬ì—…ë¡œë“œë‚˜ ì‚­ì œ í›„ ì¬ë“±ë¡ì„ ì‚¬ìš©í•˜ì„¸ìš”.</div>
      <div style="overflow:auto">
        <table>
          <colgroup>
            <col class="pnu"><col class="owner"><col class="lot"><col class="note"><col class="sign"><col class="ops">
          </colgroup>
          <thead>
            <tr>
              <th>PNU</th>
              <th>ì†Œìœ ì</th>
              <th>ì§€ë²ˆ</th>
              <th>í˜‘ì˜ ë‚´ìš©</th>
              <th class="hide-m">ì„œëª…</th>
              <th>ì‘ì—…</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnNew" class="btn accent">+ ì‹ ê·œ</button>
      </div>
    </section>

    <section class="card" id="cloudInfo">
      <strong>ì—¬ëŸ¬ ëª…ì´ í•¨ê»˜ ì“°ê¸°(ì„ íƒ)</strong>
      <div class="help">í˜„ì¬ëŠ” ë¡œì»¬ ì „ìš©ì…ë‹ˆë‹¤. ê³µë™ ì‚¬ìš©ì„ ì›í•˜ë©´ Firebase/Supabase ì—°ë™ ë²„ì „ì„ ìš”ì²­í•˜ì„¸ìš”(ì‘ì—…ë°©ë³„ ê¶Œí•œ/ë¡œê·¸ í¬í•¨).</div>
    </section>
  </main>

  <footer>
    <div class="small">â€» ì„œëª… PNGëŠ” ë¡œì»¬ DBì— <u>ì•”í˜¸í™” ì—†ì´</u> ì €ì¥ë©ë‹ˆë‹¤. ì‹¤ì„œëª…ì€ ë³„ë„ ì „ìì„œëª… ì‹œìŠ¤í…œ ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>
  </footer>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>

  <script>
  // ------------------------------
  // DB (IndexedDB via Dexie) â€” ì‘ì—…ë°©(Workspace) ì§€ì›
  // ------------------------------
  const db = new Dexie('pnu_agreements');
  db.version(1).stores({
    records: 'pnu',
    signatures: 'pnu'
  });
  db.version(2).stores({
    workspaces: 'name',
    records: '[ws+pnu], ws, pnu',
    signatures: '[ws+pnu], ws, pnu'
  }).upgrade(async tx => {
    const oldRecs = await tx.table('records').toArray().catch(()=>[]);
    const oldSigs = await tx.table('signatures').toArray().catch(()=>[]);
    if (oldRecs.length || oldSigs.length) {
      await tx.table('workspaces').put({ name: 'ê¸°ë³¸' });
      for (const r of oldRecs) {
        await tx.table('records').put({ ws:'ê¸°ë³¸', pnu:r.pnu, owner:r.owner, lot:r.lot, note:r.note });
      }
      for (const s of oldSigs) {
        await tx.table('signatures').put({ ws:'ê¸°ë³¸', pnu:s.pnu, dataUrl:s.dataUrl, signedAt:s.signedAt });
      }
    } else {
      await tx.table('workspaces').put({ name: 'ê¸°ë³¸' });
    }
  });

  // DOM helpers & state
  const $ = sel => document.querySelector(sel);
  const wsSelect = $('#wsSelect');
  const fileInput = $('#excelFile');
  const mapBox = $('#mapBox');
  const mapPnu = $('#mapPnu');
  const mapOwner = $('#mapOwner');
  const mapLot = $('#mapLot');
  const mapNote = $('#mapNote');
  const btnApplyMap = $('#btnApplyMap');
  const rowsEl = $('#rows');
  const qEl = $('#q');
  const sortOwnerAscBtn = $('#sortOwnerAsc');
  const sortOwnerDescBtn = $('#sortOwnerDesc');

  let excelHeaders = [];
  let excelRows = [];
  let currentQuery = '';
  let currentWS = localStorage.getItem('pnu_current_ws') || 'ê¸°ë³¸';
  let sortMode = 'pnu'; // 'pnu' | 'ownerAsc' | 'ownerDesc'
  let lastWS = currentWS;

  // ------------------------------
  // ì‘ì—…ë°© ì ‘ê·¼ ë³´ì•ˆ: ì§„ì… ì‹œ ì•”í˜¸ í™•ì¸
  // ------------------------------
  const WS_PASS = "lxì „ë¶ì¬ì¡°ì‚¬ì¶”ì§„ë‹¨";
  function wsKey(ws){ return `ws_authed_${ws}`; }
  async function ensureWorkspaceAuth(ws){
    if(sessionStorage.getItem(wsKey(ws)) === 'ok') return true;
    const input = prompt(`ì‘ì—…ë°© "${ws}" ì— ì ‘ê·¼í•˜ë ¤ë©´ ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.`);
    if(input === null) return false;
    if(input === WS_PASS){
      sessionStorage.setItem(wsKey(ws), 'ok');
      return true;
    }else{
      alert('ì•”í˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
      return false;
    }
  }

  // Workspaces
  async function refreshWorkspaces(){
    let list = await db.workspaces.toArray();
    if(!list.find(w=>w.name===currentWS)){
      if(list.length===0){ await db.workspaces.put({name:'ê¸°ë³¸'}); list = await db.workspaces.toArray(); }
      currentWS = list[0]?.name || 'ê¸°ë³¸';
      localStorage.setItem('pnu_current_ws', currentWS);
    }
    wsSelect.innerHTML = list.map(w=>`<option ${w.name===currentWS?'selected':''} value="${escapeHtml(w.name)}">${escapeHtml(w.name)}</option>`).join('');
  }

  wsSelect.addEventListener('change', async (e)=>{
    const targetWS = e.target.value;
    const ok = await ensureWorkspaceAuth(targetWS);
    if(!ok){
      // ë˜ëŒë¦¬ê¸°
      wsSelect.value = lastWS;
      return;
    }
    lastWS = targetWS;
    currentWS = targetWS;
    localStorage.setItem('pnu_current_ws', currentWS);
    refreshList();
  });

  // ì´ˆê¸° ë¡œë“œ ì‹œ í˜„ì¬ ì‘ì—…ë°© ì¸ì¦
  (async function guardInit(){
    await refreshWorkspaces();
    const ok = await ensureWorkspaceAuth(currentWS);
    if(!ok){
      // ì¸ì¦ ì‹¤íŒ¨ ì‹œ ë‹¤ë¥¸ ì‘ì—…ë°© ì„ íƒ ê°•ì œëŠ” í•˜ì§€ ì•Šê³ , ë‹¤ì‹œ ì‹œë„í•˜ë„ë¡ ìœ ì§€
      return;
    }
    lastWS = currentWS;
    refreshList();
  })();

  // Workspace CRUD (ìƒì„±/ì´ë¦„ë³€ê²½/ì‚­ì œ)ëŠ” ì› ì½”ë“œì™€ ë™ì¼í•˜ë˜, ì§„ì… ì‹œì—ë„ guard í•„ìš”
  $('#btnAddWs').addEventListener('click', async ()=>{
    const name = prompt('ìƒˆ ì‘ì—…ë°© ì´ë¦„ (ì˜ˆ: ì„œìš¸-ì¢…ë¡œêµ¬, Aì§€êµ¬ 1ê³µêµ¬ ë“±)');
    if(!name) return; const n = name.trim(); if(!n) return;
    const exists = await db.workspaces.get(n);
    if(exists){ alert('ê°™ì€ ì´ë¦„ì˜ ì‘ì—…ë°©ì´ ì´ë¯¸ ìˆìŠµë‹ˆë‹¤.'); return; }
    await db.workspaces.put({ name:n });
    await refreshWorkspaces();
    // ë°©ê¸ˆ ë§Œë“  ì‘ì—…ë°© ì§„ì… ì „ ì¸ì¦
    const ok = await ensureWorkspaceAuth(n);
    if(!ok){ return; }
    currentWS = n; lastWS = n; localStorage.setItem('pnu_current_ws', currentWS);
    await refreshWorkspaces(); await refreshList();
  });

  $('#btnRenameWs').addEventListener('click', async ()=>{
    const old = currentWS;
    const neo = prompt(`ì‘ì—…ë°© ì´ë¦„ ë³€ê²½: ${old} â†’`, old);
    if(neo===null) return; const n = neo.trim(); if(!n) return;
    if(n===old) return;
    if(await db.workspaces.get(n)){ alert('í•´ë‹¹ ì´ë¦„ì€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.'); return; }
    await db.transaction('rw', db.workspaces, db.records, db.signatures, async ()=>{
      await db.workspaces.delete(old);
      await db.workspaces.put({ name:n });
      const recs = await db.records.where('ws').equals(old).toArray();
      for(const r of recs){ await db.records.delete([old, r.pnu]); await db.records.put({ ...r, ws:n }); }
      const sigs = await db.signatures.where('ws').equals(old).toArray();
      for(const s of sigs){ await db.signatures.delete([old, s.pnu]); await db.signatures.put({ ...s, ws:n }); }
    });
    // ìƒˆ ì´ë¦„ ì¸ì¦
    const ok = await ensureWorkspaceAuth(n);
    if(!ok){ return; }
    currentWS = n; lastWS = n; localStorage.setItem('pnu_current_ws', currentWS);
    await refreshWorkspaces(); await refreshList();
  });

  $('#btnDelWs').addEventListener('click', async ()=>{
    const name = currentWS;
    const list = await db.workspaces.toArray();
    if(list.length<=1){ alert('ìµœì†Œ 1ê°œì˜ ì‘ì—…ë°©ì€ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
    if(!confirm(`ì‘ì—…ë°© "${name}"ì„(ë¥¼) ì‚­ì œí• ê¹Œìš”?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ê³ , í•´ë‹¹ ì‘ì—…ë°©ì˜ ëª¨ë“  ë ˆì½”ë“œ/ì„œëª…ì´ ì‚­ì œë©ë‹ˆë‹¤.`)) return;
    await db.transaction('rw', db.workspaces, db.records, db.signatures, async ()=>{
      await db.workspaces.delete(name);
      const recs = await db.records.where('ws').equals(name).toArray();
      for(const r of recs){ await db.records.delete([name, r.pnu]); }
      const sigs = await db.signatures.where('ws').equals(name).toArray();
      for(const s of sigs){ await db.signatures.delete([name, s.pnu]); }
    });
    const remain = await db.workspaces.toArray();
    currentWS = remain[0].name; lastWS = currentWS; localStorage.setItem('pnu_current_ws', currentWS);
    await refreshWorkspaces(); await refreshList();
  });

  // ------------------------------
  // ì—‘ì…€ ì—…ë¡œë“œ & ë§¤í•‘
  // ------------------------------
  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if(!file) return;
    const { headers, rows } = await parseExcel(file);
    excelHeaders = headers; excelRows = rows;
    buildMappingSelects(headers);
    mapBox.style.display = 'block';
  });

  function buildMappingSelects(headers){
    const fill = (sel, guessList=[]) => {
      sel.innerHTML = '<option value="">(ì‚¬ìš© ì•ˆí•¨)</option>' + headers.map((h,i)=>`<option value="${i}">${escapeHtml(h)}</option>`).join('');
      for(const g of guessList){
        const idx = headers.findIndex(h => h.toLowerCase().includes(g));
        if(idx>=0){ sel.value = String(idx); break; }
      }
    }
    fill(mapPnu,   ['pnu','í•„ì§€','ê³ ìœ ','parcel']);
    fill(mapOwner, ['ì†Œìœ ','owner','ì„±ëª…','ì´ë¦„','ëŒ€í‘œ']);
    fill(mapLot,   ['ì§€ë²ˆ','ì£¼ì†Œ','lot','parcel','address']);
    fill(mapNote,  ['í˜‘ì˜','ë‚´ìš©','ë¹„ê³ ','note','memo']);
  }

  btnApplyMap.addEventListener('click', async () => {
    if(!excelRows.length){ alert('ì—‘ì…€ì„ ë¨¼ì € ë¶ˆëŸ¬ì˜¤ì„¸ìš”.'); return; }
    const idx = {
      pnu: parseInt(mapPnu.value,10),
      owner: parseInt(mapOwner.value,10),
      lot: parseInt(mapLot.value,10),
      note: parseInt(mapNote.value,10)
    };
    if(Number.isNaN(idx.pnu)) { alert('PNU ë§¤í•‘ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
    let upserted = 0;
    await db.transaction('rw', db.records, async () => {
      for(const row of excelRows){
        const rec = {
          ws: currentWS,
          pnu: normalizePnu(cell(row, idx.pnu)),
          owner: cell(row, idx.owner),
          lot: cell(row, idx.lot),
          note: cell(row, idx.note)
        };
        if(!rec.pnu) continue;
        await db.records.put(rec);
        upserted++;
      }
    });
    alert(`(${currentWS}) ì´ ${upserted.toLocaleString()}ê±´ ì €ì¥/ê°±ì‹  ì™„ë£Œ.`);
    mapBox.style.display = 'none';
    fileInput.value = '';
    await refreshList();
  });

  async function parseExcel(file){
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, { type:'array' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { header:1, defval:'' });
    const headers = rows.shift()?.map(String) ?? [];
    return { headers, rows };
  }
  function cell(row, idx){ if(Number.isNaN(idx)) return ''; return (row?.[idx] ?? '').toString().trim(); }
  function normalizePnu(v){ if(!v) return ''; return String(v).replace(/\s+/g,'').replace(/[^0-9-]/g,''); }

  // ------------------------------
  // ëª©ë¡ ë Œë” (ì •ë ¬/ê²€ìƒ‰/ì„œëª… ìƒíƒœ)
  // ------------------------------
  async function refreshList(){
    const all = await db.records.where('ws').equals(currentWS).toArray();
    const sigs = await db.signatures.where('ws').equals(currentWS).toArray();
    const sigMap = new Map(sigs.map(s => [s.pnu, s]));

    const q = currentQuery.trim().toLowerCase();
    let filtered = q
      ? all.filter(r =>
          r.pnu.toLowerCase().includes(q) ||
          (r.owner||'').toLowerCase().includes(q) ||
          (r.lot||'').toLowerCase().includes(q)
        )
      : all;

    // ì •ë ¬
    if(sortMode==='ownerAsc'){
      filtered.sort((a,b)=> (a.owner||'').localeCompare(b.owner||'','ko'));
    }else if(sortMode==='ownerDesc'){
      filtered.sort((a,b)=> (b.owner||'').localeCompare(a.owner||'','ko'));
    }else{
      filtered.sort((a,b)=> a.pnu.localeCompare(b.pnu));
    }

    rowsEl.innerHTML = filtered.map(r => {
      const s = sigMap.get(r.pnu);
      const signed = !!s?.dataUrl;
      const when = s?.signedAt ? new Date(s.signedAt).toLocaleString() : '';
      const pnuEnc = encodeURIComponent(r.pnu);
      return `<tr>
        <td title="${escapeHtml(r.pnu)}"><span class="small muted">#</span> ${escapeHtml(r.pnu)}</td>
        <td title="${escapeHtml(r.owner||'')}">${escapeHtml(r.owner||'')}</td>
        <td title="${escapeHtml(r.lot||'')}">${escapeHtml(r.lot||'')}</td>
        <td title="${escapeHtml((r.note||'').replace(/\n/g,' '))}">${escapeHtml(r.note||'')}</td>
        <td class="hide-m">${signed?`<span class="pill ok">ì„œëª… ì™„ë£Œ</span><div class="small muted">${escapeHtml(when)}</div>`:`<span class="pill no">ë¯¸ì„œëª…</span>`}</td>
        <td>
          <div class="row" style="gap:6px">
            <button class="btn btn-edit"    data-pnu="${pnuEnc}">âœï¸ í˜‘ì˜ë‚´ìš© ìˆ˜ì •</button>
            <button class="btn accent btn-sign"   data-pnu="${pnuEnc}">â¬†ï¸ ì„œëª… ì—…ë¡œë“œ(PNG)</button>
            <button class="btn btn-preview" data-pnu="${pnuEnc}">ğŸ–¼ï¸ ì„œëª…ë³´ê¸°</button>
            <button class="btn danger btn-del"    data-pnu="${pnuEnc}">ğŸ—‘ï¸ ì‚­ì œ</button>
          </div>
        </td>
      </tr>`;
    }).join('');
  }

  // ê²€ìƒ‰ & ì •ë ¬
  qEl.addEventListener('input', (e)=>{ currentQuery = e.target.value; refreshList(); });
  sortOwnerAscBtn.addEventListener('click', ()=>{ sortMode='ownerAsc'; refreshList(); });
  sortOwnerDescBtn.addEventListener('click', ()=>{ sortMode='ownerDesc'; refreshList(); });

  // ì‹ ê·œ
  $('#btnNew').addEventListener('click', async ()=>{
    const pnu = prompt(`[${currentWS}] ì‹ ê·œ PNU (ê³ ìœ í‚¤)`);
    if(pnu===null) return;
    const key = normalizePnu(pnu);
    if(!key){ alert('PNUëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
    const owner = prompt('ì†Œìœ ì:') ?? '';
    const lot = prompt('ì§€ë²ˆ:') ?? '';
    // í˜‘ì˜ë‚´ìš©ì€ ì•„ë˜ ëª¨ë‹¬ì—ì„œ ë°”ë¡œ í¸ì§‘í•˜ë„ë¡ ë¹ˆê°’ìœ¼ë¡œ ìƒì„±
    await db.records.put({ ws:currentWS, pnu:key, owner:owner.trim(), lot:lot.trim(), note:'' });
    // ìƒì„± ì§í›„ í˜‘ì˜ë‚´ìš© ëª¨ë‹¬ ì—´ê¸°
    openNoteModal(key, '');
  });

  // ------------------------------
  // ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ ë²„íŠ¼ ì²˜ë¦¬
  // ------------------------------
  rowsEl.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    const pnu = decodeURIComponent(btn.dataset.pnu || '');
    if(!pnu) return;

    if(btn.classList.contains('btn-edit')){
      const rec = await db.records.get([currentWS, pnu]);
      if(!rec){ alert('ë ˆì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      openNoteModal(pnu, rec.note || '');
    }
    else if(btn.classList.contains('btn-sign')){
      openUploadModal(pnu);
    }
    else if(btn.classList.contains('btn-preview')){
      const s = await db.signatures.get([currentWS, pnu]);
      if(!s?.dataUrl){ alert('ì„œëª…ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const win = window.open(); win.document.write(`<img alt="signature" src="${s.dataUrl}">`);
    }
    else if(btn.classList.contains('btn-del')){
      if(!confirm(`ì‚­ì œí• ê¹Œìš”?\n[${currentWS}] PNU: ${pnu}`)) return;
      await db.transaction('rw', db.records, db.signatures, async () => {
        await db.records.delete([currentWS, pnu]);
        await db.signatures.delete([currentWS, pnu]);
      });
      refreshList();
    }
  });

  // ------------------------------
  // í˜‘ì˜ ë‚´ìš© ìˆ˜ì • ëª¨ë‹¬ (textarea)
  // ------------------------------
  let noteModal, noteTextarea, noteSaveBtn, noteCloseBtn, notePnuLabel, notePnu='';
  function ensureNoteModal(){
    if(noteModal) return;
    noteModal = document.createElement('div');
    noteModal.className = 'modal';
    noteModal.innerHTML = `
      <div class="sheet">
        <div class="row" style="align-items:center">
          <h3 style="margin:0">í˜‘ì˜ ë‚´ìš© ìˆ˜ì •</h3>
          <span class="right"></span>
          <button class="btn" id="btnCloseNote">ë‹«ê¸°</button>
        </div>
        <div class="help" id="noteTarget" style="margin:6px 0 10px"></div>
        <textarea id="noteTextarea" rows="8" placeholder="í˜‘ì˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”(ì¤„ë°”ê¿ˆ ê°€ëŠ¥)"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn brand" id="btnSaveNote">ì €ì¥</button>
        </div>
      </div>`;
    document.body.appendChild(noteModal);
    noteTextarea = noteModal.querySelector('#noteTextarea');
    noteSaveBtn = noteModal.querySelector('#btnSaveNote');
    noteCloseBtn = noteModal.querySelector('#btnCloseNote');
    notePnuLabel = noteModal.querySelector('#noteTarget');

    noteCloseBtn.addEventListener('click', ()=> noteModal.classList.remove('open'));
    noteSaveBtn.addEventListener('click', async ()=>{
      const rec = await db.records.get([currentWS, notePnu]);
      if(!rec){ alert('ë ˆì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      await db.records.put({ ...rec, note: noteTextarea.value.trim() });
      noteModal.classList.remove('open');
      refreshList();
    });
  }
  function openNoteModal(pnu, note){
    ensureNoteModal();
    notePnu = pnu;
    notePnuLabel.textContent = `[${currentWS}] PNU ${pnu}`;
    noteTextarea.value = note || '';
    noteModal.classList.add('open');
    noteTextarea.focus();
  }

  // ------------------------------
  // ì„œëª… ì—…ë¡œë“œ ëª¨ë‹¬ (PNG)
  // ------------------------------
  let upModal, upFile, upSaveBtn, upCloseBtn, upPnuLabel, upPreviewImg, upPnu='';
  function ensureUploadModal(){
    if(upModal) return;
    upModal = document.createElement('div');
    upModal.className = 'modal';
    upModal.innerHTML = `
      <div class="sheet">
        <div class="row" style="align-items:center">
          <h3 style="margin:0">ì„œëª… ì—…ë¡œë“œ (PNG)</h3>
          <span class="right"></span>
          <button class="btn" id="btnCloseUpload">ë‹«ê¸°</button>
        </div>
        <div class="help" id="upTarget" style="margin:6px 0 10px"></div>
        <input id="upFile" type="file" accept="image/png">
        <div class="help" style="margin-top:8px">â€» PNGë§Œ í—ˆìš©ë©ë‹ˆë‹¤. ì—…ë¡œë“œ ì‹œ ë¡œì»¬ DBì— Data URLë¡œ ì €ì¥ë©ë‹ˆë‹¤.</div>
        <div style="margin-top:10px"><img id="upPreview" alt="ë¯¸ë¦¬ë³´ê¸°" style="max-width:100%;border-radius:8px;display:none"></div>
        <div class="row" style="margin-top:10px">
          <button class="btn brand" id="btnSaveUpload">ì €ì¥</button>
        </div>
      </div>`;
    document.body.appendChild(upModal);
    upFile = upModal.querySelector('#upFile');
    upSaveBtn = upModal.querySelector('#btnSaveUpload');
    upCloseBtn = upModal.querySelector('#btnCloseUpload');
    upPnuLabel = upModal.querySelector('#upTarget');
    upPreviewImg = upModal.querySelector('#upPreview');

    upCloseBtn.addEventListener('click', ()=> upModal.classList.remove('open'));
    upFile.addEventListener('change', ()=>{
      const f = upFile.files?.[0];
      if(!f){ upPreviewImg.style.display='none'; return; }
      if(f.type !== 'image/png'){ alert('PNG í˜•ì‹ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); upFile.value=''; upPreviewImg.style.display='none'; return; }
      const reader = new FileReader();
      reader.onload = (ev)=>{
        upPreviewImg.src = ev.target.result;
        upPreviewImg.style.display = 'block';
      };
      reader.readAsDataURL(f);
    });
    upSaveBtn.addEventListener('click', async ()=>{
      const f = upFile.files?.[0];
      if(!f){ alert('íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }
      if(f.type !== 'image/png'){ alert('PNG í˜•ì‹ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }
      const dataUrl = upPreviewImg.src;
      await db.signatures.put({ ws:currentWS, pnu: upPnu, dataUrl, signedAt: new Date().toISOString() });
      upModal.classList.remove('open');
      upFile.value=''; upPreviewImg.style.display='none';
      refreshList();
    });
  }
  async function openUploadModal(pnu){
    ensureUploadModal();
    upPnu = pnu;
    const rec = await db.records.get([currentWS, upPnu]);
    if(!rec){ alert('ë ˆì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
    upPnuLabel.textContent = `[${currentWS}] PNU ${rec.pnu} Â· ${rec.owner||''} Â· ${rec.lot||''}`;
    upModal.classList.add('open');
  }

  // ------------------------------
  // Export/Import/Template/Reset
  // ------------------------------
  $('#btnExportXlsx').addEventListener('click', async ()=>{
    // SheetJS(ì»¤ë®¤ë‹ˆí‹° ë¹Œë“œ)ëŠ” ì…€ì— 'ì´ë¯¸ì§€ ì‚½ì…' ê¸°ëŠ¥ì´ ê³µì‹ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    // ëŒ€ì‹  Data URL(ì„œëª… PNG)ì„ í…ìŠ¤íŠ¸ë¡œ ì…€ì— í¬í•¨ì‹œí‚µë‹ˆë‹¤.
    const recs = await db.records.where('ws').equals(currentWS).toArray();
    const sigMap = new Map((await db.signatures.where('ws').equals(currentWS).toArray()).map(s => [s.pnu, s]));
    const rows = recs.map(r=>{
      const sig = sigMap.get(r.pnu);
      return {
        ì‘ì—…ë°©: currentWS,
        PNU: r.pnu,
        ì†Œìœ ì: r.owner||'',
        ì§€ë²ˆ: r.lot||'',
        í˜‘ì˜ë‚´ìš©: r.note||'',
        ì„œëª…ì—¬ë¶€: sig ? 'Y' : 'N',
        ì„œëª…ì‹œê°: sig?.signedAt ? new Date(sig.signedAt).toLocaleString() : '',
        ì„œëª…PNG_DataURL: sig?.dataUrl || ''  // Data URLë¡œ ë‚´ë³´ëƒ„
      };
    });
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(rows);
    // ì—´ ë„ˆë¹„ ì‚´ì§ ë„“ê²Œ
    ws['!cols'] = [
      {wch:12},{wch:20},{wch:12},{wch:18},{wch:40},{wch:8},{wch:20},{wch:50}
    ];
    XLSX.utils.book_append_sheet(wb, ws, currentWS.slice(0,31));
    XLSX.writeFile(wb, `pnu_${sanitizeFile(currentWS)}_${fmtDate()}.xlsx`);
  });

  $('#btnExportJson').addEventListener('click', async ()=>{
    const payload = {
      exportedAt: new Date().toISOString(),
      workspaces: await db.workspaces.toArray(),
      records: await db.records.toArray(),
      signatures: await db.signatures.toArray()
    };
    downloadBlob(new Blob([JSON.stringify(payload,null,2)], {type:'application/json'}), `pnu_backup_all_${fmtDate()}.json`);
  });
  $('#btnImportJson').addEventListener('click', ()=> $('#jsonFile').click());
  $('#jsonFile').addEventListener('change', async (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    const text = await f.text();
    const data = JSON.parse(text);
    if(!Array.isArray(data.records) || !Array.isArray(data.signatures)) { alert('ë°±ì—… í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); return; }
    await db.transaction('rw', db.workspaces, db.records, db.signatures, async ()=>{
      await db.workspaces.clear(); await db.records.clear(); await db.signatures.clear();
      const wsList = data.workspaces?.length ? data.workspaces : [{name:'ê¸°ë³¸'}];
      for(const w of wsList) await db.workspaces.put({ name:w.name });
      for(const r of data.records) await db.records.put(r);
      for(const s of data.signatures) await db.signatures.put(s);
    });
    await refreshWorkspaces(); alert('ë³µì› ì™„ë£Œ'); refreshList();
  });

  $('#btnTemplate').addEventListener('click', ()=>{
    const wb = XLSX.utils.book_new();
    const rows = [ { PNU:'1111010100100000000', ì†Œìœ ì:'í™ê¸¸ë™', ì§€ë²ˆ:'ì„œìš¸ ì¢…ë¡œêµ¬ 1-1', í˜‘ì˜ë‚´ìš©:'ë³´ìƒ í˜‘ì˜ 1ì°¨ ì™„ë£Œ' } ];
    const ws = XLSX.utils.json_to_sheet(rows); XLSX.utils.book_append_sheet(wb, ws, 'í…œí”Œë¦¿');
    XLSX.writeFile(wb, 'pnu_template.xlsx');
  });

  $('#btnReset').addEventListener('click', async ()=>{
    if(!confirm('DBë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”? ëª¨ë“  ì‘ì—…ë°©ì˜ ë ˆì½”ë“œ/ì„œëª…ì´ ì‚­ì œë©ë‹ˆë‹¤.')) return;
    await db.transaction('rw', db.workspaces, db.records, db.signatures, async ()=>{
      await db.workspaces.clear(); await db.records.clear(); await db.signatures.clear();
    });
    await db.workspaces.put({ name:'ê¸°ë³¸' }); currentWS='ê¸°ë³¸'; lastWS='ê¸°ë³¸'; localStorage.setItem('pnu_current_ws', currentWS);
    await refreshWorkspaces(); refreshList();
  });

  // Helpers
  function fmtDate(){ const d = new Date(); const p = n=> String(n).padStart(2,'0'); return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}`; }
  function downloadBlob(blob, filename){ const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click(); setTimeout(()=> URL.revokeObjectURL(a.href), 2000); }
  function escapeHtml(s){ return String(s??'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
  function sanitizeFile(s){ return s.replace(/[^\w\-ê°€-í£]/g,'_').slice(0,60); }

  // Excel ìœ í‹¸ ë
  </script>
</body>
</html>
