<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PNU í˜‘ì˜Â·ì„œëª… ê´€ë¦¬ (Firestore + IndexedDB)</title>
  <style>
    body { font-family:sans-serif; background:#0b1226; color:#e8eefb; margin:0; }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .btn{padding:6px 12px;border-radius:6px;border:1px solid #444;background:#223;color:#fff;cursor:pointer}
    .card{background:#111834;border-radius:8px;padding:12px;margin:8px 0}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #333;padding:6px;font-size:13px}
    textarea{width:100%;height:120px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
    .modal.open{display:flex}
    .modal .sheet{background:#111834;padding:16px;border-radius:12px;max-width:90%}
    canvas{width:100%;height:200px;background:#fff;border:1px solid #ccc;border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ“‘ PNU í˜‘ì˜Â·ì„œëª… ê´€ë¦¬</h1>

    <div class="card">
      <label>ì‘ì—…ë°©</label>
      <select id="wsSelect"></select>
      <button class="btn" id="btnAddWs">+ ì‘ì—…ë°©</button>
    </div>

    <div class="card">
      <label class="btn" for="excelFile">ğŸ“¥ ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°</label>
      <input id="excelFile" type="file" accept=".xlsx,.xls" style="display:none"/>
      <button class="btn" id="btnExportXlsx">ğŸ“¤ ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
    </div>

    <div class="card">
      <input id="q" placeholder="ê²€ìƒ‰(PNU/ì†Œìœ ì/ì§€ë²ˆ)"/>
      <button class="btn" id="btnNew">+ ì‹ ê·œ</button>
      <table>
        <thead>
          <tr><th>PNU</th><th>ì†Œìœ ì</th><th>ì§€ë²ˆ</th><th>í˜‘ì˜ë‚´ìš©</th><th>ì„œëª…</th><th>ì‘ì—…</th></tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

  <!-- ëª¨ë‹¬(í˜‘ì˜ë‚´ìš©) -->
  <div id="noteModal" class="modal">
    <div class="sheet">
      <h3>í˜‘ì˜ ë‚´ìš© ìˆ˜ì •</h3>
      <div id="noteTarget" style="font-size:12px;color:#ccc"></div>
      <textarea id="noteTextarea"></textarea>
      <button class="btn" id="btnSaveNote">ì €ì¥</button>
      <button class="btn" id="btnCloseNote">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- ëª¨ë‹¬(ì„œëª…) -->
  <div id="sigModal" class="modal">
    <div class="sheet">
      <h3>ì„œëª… ì¶”ê°€</h3>
      <input type="file" id="sigFile" accept="image/png"/>
      <p style="font-size:12px;color:#ccc">ë˜ëŠ” ì§ì ‘ ì„œëª…:</p>
      <canvas id="sigCanvas"></canvas>
      <div>
        <button class="btn" id="btnClearSig">ì§€ìš°ê¸°</button>
        <button class="btn" id="btnSaveSig">ì €ì¥</button>
        <button class="btn" id="btnCloseSig">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <!-- Firebase init -->
  <script type="module" id="firebase-init">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDh8dyrAbshk0npKTxzAdaX3_426txbRpI",
      authDomain: "jajosa-8d811.firebaseapp.com",
      projectId: "jajosa-8d811",
      storageBucket: "jajosa-8d811.appspot.com",
      messagingSenderId: "616881022512",
      appId: "1:616881022512:web:cf3b8c32f4535bb65aff5",
      measurementId: "G-9J5C7KHZCG"
    };
    const app = initializeApp(firebaseConfig);
    const fdb = getFirestore(app);
    window.__fdb = fdb;
  </script>

  <!-- ì•± ë¡œì§ -->
  <script>
  const db = new Dexie("pnu_agreements");
  db.version(1).stores({ workspaces:"name", records:"[ws+pnu],ws,pnu", signatures:"[ws+pnu],ws,pnu" });

  const $ = sel=>document.querySelector(sel);
  const wsSelect=$("#wsSelect"), rowsEl=$("#rows");

  let currentWS="ê¸°ë³¸", sigPad, sigPnu="";

  async function init(){
    await db.workspaces.put({name:"ê¸°ë³¸"});
    refreshWS();
    refreshList();
  }

  async function refreshWS(){
    const list=await db.workspaces.toArray();
    wsSelect.innerHTML=list.map(w=>`<option ${w.name===currentWS?"selected":""}>${w.name}</option>`).join("");
  }

  async function refreshList(){
    const recs=await db.records.where("ws").equals(currentWS).toArray();
    const sigs=await db.signatures.where("ws").equals(currentWS).toArray();
    const sigMap=new Map(sigs.map(s=>[s.pnu,s]));
    rowsEl.innerHTML=recs.map(r=>{
      const s=sigMap.get(r.pnu);
      return `<tr>
        <td>${r.pnu}</td><td>${r.owner||""}</td><td>${r.lot||""}</td><td>${r.note||""}</td>
        <td>${s?"âœ…":"âŒ"}</td>
        <td>
          <button class="btn" onclick="openNote('${r.pnu}')">âœï¸</button>
          <button class="btn" onclick="openSign('${r.pnu}')">âœï¸</button>
          <button class="btn" onclick="delRec('${r.pnu}')">ğŸ—‘ï¸</button>
        </td>
      </tr>`;
    }).join("");
  }

  // ì‹ ê·œ ì¶”ê°€
  $("#btnNew").addEventListener("click", async()=>{
    const pnu=prompt("PNU"); if(!pnu) return;
    const owner=prompt("ì†Œìœ ì")||"", lot=prompt("ì§€ë²ˆ")||"";
    await db.records.put({ws:currentWS,pnu,owner,lot,note:""});
    refreshList();
  });

  // í˜‘ì˜ë‚´ìš© ëª¨ë‹¬
  const noteModal=$("#noteModal"), noteTextarea=$("#noteTextarea");
  function openNote(pnu){ noteModal.classList.add("open"); noteModal.dataset.pnu=pnu; }
  $("#btnSaveNote").onclick=async()=>{
    const pnu=noteModal.dataset.pnu, rec=await db.records.get([currentWS,pnu]);
    rec.note=noteTextarea.value; await db.records.put(rec);
    noteModal.classList.remove("open"); refreshList();
  };
  $("#btnCloseNote").onclick=()=> noteModal.classList.remove("open");

  // ì„œëª… ëª¨ë‹¬
  const sigModal=$("#sigModal"), sigCanvas=$("#sigCanvas");
  sigPad=new window.SignaturePad(sigCanvas,{backgroundColor:"white",penColor:"black"});
  function openSign(pnu){ sigPnu=pnu; sigModal.classList.add("open"); }
  $("#btnClearSig").onclick=()=>sigPad.clear();
  $("#btnCloseSig").onclick=()=>sigModal.classList.remove("open");
  $("#btnSaveSig").onclick=async()=>{
    let dataUrl="";
    const f=$("#sigFile").files[0];
    if(f){ dataUrl=await fileToDataURL(f); }
    else { if(sigPad.isEmpty()){alert("ì„œëª…ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤."); return;} dataUrl=sigPad.toDataURL("image/png"); }
    await db.signatures.put({ws:currentWS,pnu:sigPnu,dataUrl,signedAt:new Date().toISOString()});
    sigModal.classList.remove("open"); refreshList();
  };
  async function fileToDataURL(f){return new Promise(res=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.readAsDataURL(f);});}

  // ì‚­ì œ
  async function delRec(pnu){ await db.records.delete([currentWS,pnu]); await db.signatures.delete([currentWS,pnu]); refreshList(); }

  // ì—‘ì…€ ë¶ˆëŸ¬ì˜¤ê¸°
  $("#excelFile").addEventListener("change", async e=>{
    const f=e.target.files[0]; if(!f) return;
    const data=await f.arrayBuffer();
    const wb=XLSX.read(data,{type:"array"});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{defval:""});
    let cnt=0;
    for(const r of rows){
      if(!r.PNU) continue;
      await db.records.put({ws:currentWS,pnu:String(r.PNU),owner:r.ì†Œìœ ì||"",lot:r.ì§€ë²ˆ||"",note:r.í˜‘ì˜ë‚´ìš©||""});
      cnt++;
    }
    alert(cnt+"ê±´ ë¶ˆëŸ¬ì˜´"); refreshList();
  });

  // ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
  $("#btnExportXlsx").onclick=async()=>{
    const wb=new ExcelJS.Workbook(); const ws=wb.addWorksheet("data");
    ws.addRow(["PNU","ì†Œìœ ì","ì§€ë²ˆ","í˜‘ì˜ë‚´ìš©","ì„œëª…ì—¬ë¶€","ì„œëª…ì‹œê°"]);
    const recs=await db.records.where("ws").equals(currentWS).toArray();
    const sigs=await db.signatures.where("ws").equals(currentWS).toArray(); const sigMap=new Map(sigs.map(s=>[s.pnu,s]));
    for(const r of recs){
      const s=sigMap.get(r.pnu);
      ws.addRow([r.pnu,r.owner,r.lot,r.note,s?"Y":"N",s?.signedAt||""]);
    }
    const buf=await wb.xlsx.writeBuffer();
    saveAs(new Blob([buf]),"pnu.xlsx");
  };

  init();
  </script>
</body>
</html>
